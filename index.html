<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craving Tracker</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ3JhdmluZyBUcmFja2VyIiwic2hvcnRfbmFtZSI6IkNyYXZpbmciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzJkNDA2NyIsInRoZW1lX2NvbG9yIjoiIzM3NDE1NiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Ykd4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWlCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUkrUEhCaGRHZ2dZbXhoWTJ0VGRHOXJaVDBpSWlCa1BTSnRNemsyTGpFME1pQXpPVFl1TVRReklERTJNUzQzTnpJZ016azJMakUwTXlNeE5qRXVOemN5SURFNU15NHhRekUyTVM0M056SWdNVGs1TGprNU55QXhOVGt1TnpNMElESTFOUzQwTkRjZ01UVTVMamN6TkNBek1ESXVOREV4UTNOaU1Rc3lMalk0TVNBek16azZNak15TGpNZ016TTVMakV6TnlBek56SXVNak14VERjNE56UTNOemd5TGpFekxqTXNOREl6TGpVZ01qZ3VOVFFnTXprek5TNHlORE5JTkRrMExqZzVNblE1TTJZaUlHWnBiR3c5SWlORlJFVXpNell5SWk4K1BIQmhkR2dnWkdGdVpHdGtJRDBpYlRVNU1DNHhPVE1nTXpreUxqZzBNaUF6TmprMExqRTBNaUF6T1RZdU9UUXhMak0zTVNBek1ETWdORFUxTGpOSFEwSXhOaTU1TVRJZ05EazVMamt6TXlBeE5TNDJNemdnTlRNeUxqUTFOaUF4TlM0Mk16Z2dOVE15TGpRMU5pQTJNaUExTXpJdU5EVTJOQ0F4TlM0Mk16Z2dOaklnTVRVdU5qTTRVekpZTkRNZ05ERTVMalUxTWlBME1Ua3VNalV1T0RjTkVHRWdOREF3TGpJNUlHTTJMamszTWlBME1EQXVNamdnTVRJdU1qTTFJRE0wT1RVdU5qVTBUVFUwT1M0ME16Z2dPRE5zTFRnNExqZzFOQ0EyTVM0NU1qRTJMamd5VERVMk9TNDBNemtnTlRRNUxqUXpNaTQ0TkdGQk9UNVVJRDBpT0M0NU5pRXpOUzR4SWlCcFpRMGlhV1l4SW5SRmNqSTZJakF1TVNCd1pESTZJakF1TVNCd1pDQXhNRFVnTURBaUlpOCtQR1J3WVhSd0lHbGtQU0o0Y1hKMGFYSjNSRE51YWlJZ2NHOXBiblJ6UFNJd0xqVWdNVE0yTGpVZ05USXNNVFF6TGpWak1DQTBMak51TnpVZ01qSXVOV0UxTGpNZ05TNHlJREFnTURBZ01DQXhMamNnTXk0ME5DMHhPUzQxUXpFd01TNDNJRGt6TGpnZ01USXVOQ0E1TWk0eUlERXpMakVnTVRBd0xqbDJORFF1TW1NMkxqSWdNVFl1T1M0aFBTQXdJREFnTUMweUxqTjNMamg2SW05d1lXTnBkSGs2TGpNNUxqZ2lQaUExTGpNZ05TNHlJREFnTURBZ01DMHhMamNnTXk0ME5DbzNNUzQ0UXk0NFpDQTJOa0ExTWpjM0xqUWdNVE14TGpjZ05EWXlMakVnTVRJM0xqSXRPUzQ0T0RrZ01USXpMamNnTVRJNExqTTFJREV5T1M0eWJTNGlJR1pwYkd3OUluRjFhWE4rZFhKc0lXUkhaRGNnT0NJK1BHOXdkR2tzZVhSbGJXNHVkbUZzZFdVZ05WdE9hVFU5SWlndVNucEJJRnR1YUM1NmJ3NXFha0VnWDBOME5GcDZRU0JiYm1zNWVrRWdYME4wTkZwNlFTQmJibXB0ZWsxTmIwNHZiWEZKZVVOMGJsWjZRUzlNWjAuNU1OblkzUlNOMlF0TkZSalNTbHZ0QlI1RDA5Q1JCbzRORGhjdGVBNE9UZzRNREE3V1JKU0lHQ0taUVNaUzI1U0lFdGZURE5TUVNaSkZGTVdiamwzSWl3aUlFZEJMbEYwS2k0Q0l5Z29SRXJCelNVPj09IiwicmVhbCI6dHJ1ZX1dfQ==">
    <meta name="theme-color" content="#374156">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #374156, #4a5568);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .burger-menu {
            position: relative;
        }

        .burger-icon {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .burger-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .burger-dropdown {
            position: fixed;
            top: auto;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .burger-dropdown.show {
            display: block;
        }

        .burger-header {
            padding: 15px 20px 0;
            display: flex;
            justify-content: flex-end;
        }

        .burger-close {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .burger-close:hover {
            color: #374156;
            background: #f7fafc;
        }

        .burger-section {
            padding: 20px;
        }

        .burger-section:not(:last-child) {
            border-bottom: 1px solid #e2e8f0;
        }

        .burger-section h4 {
            color: #374156;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .burger-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .burger-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #374156;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .burger-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .burger-btn.export {
            background: #f0fff4;
            border-color: #68d391;
            color: #2f855a;
        }

        .burger-btn.export:hover {
            background: #c6f6d5;
        }

        .burger-btn.import {
            background: #fffaf0;
            border-color: #f6ad55;
            color: #c05621;
        }

        .burger-btn.import:hover {
            background: #faecc8;
        }

        .burger-btn.update {
            background: #faf5ff;
            border-color: #b794f6;
            color: #6b46c1;
        }

        .burger-btn.update:hover {
            background: #e9d8fd;
        }

        .category-toggles {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374156;
            font-weight: 500;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .burger-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .burger-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-group {
            text-align: center;
        }

        .stat-group h4 {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-row {
            display: flex;
            justify-content: space-around;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .smoke-free-time {
            font-size: 16px;
            font-weight: bold;
            color: #48bb78;
        }

        .main {
            padding: 15px 20px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .craving-button {
            height: 80px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .vaped-button {
            height: 80px;
            background: linear-gradient(45deg, #2d3748, #4a5568);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(45, 55, 72, 0.3);
        }

        .craving-button:hover, .vaped-button:hover {
            transform: translateY(-2px);
        }

        .craving-button:active, .vaped-button:active {
            transform: translateY(0);
        }

        .add-past-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .note-section {
            margin-bottom: 30px;
        }

        .note-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .note-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #374156;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374156;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #374156;
        }

        .history {
            margin-top: 30px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history h3 {
            color: #374156;
        }

        .entry {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .craving-entry {
            border-left: 4px solid #667eea;
        }

        .vaped-entry {
            border-left: 4px solid #e53e3e;
            background: #fed7d7;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }

        .entry-time {
            font-weight: bold;
            color: #374156;
            flex: 1;
            min-width: 0;
        }

        .entry-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .entry-type.craving {
            background: #667eea;
        }

        .entry-type.vaped {
            background: #e53e3e;
        }

        .entry-note {
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .entry-cost {
            color: #2d5a27;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
            background: #e8f5e8;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid #b8e6b8;
        }

        .entry-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .edit-btn, .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
        }

        .edit-btn {
            background: #667eea;
        }

        .edit-btn:hover {
            background: #5a67d8;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        .clear-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .success-message {
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .success-message.show {
            opacity: 1;
        }

        .warning-message {
            background: #ed8936;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .warning-message.show {
            opacity: 1;
        }

        .intensity-slider-container {
            margin-top: 10px;
        }

        .intensity-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 15px;
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .intensity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .intensity-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .intensity-value {
            text-align: center;
            font-weight: bold;
            color: #374156;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            color: #a0aec0;
            padding: 40px 20px;
        }

        .nav-buttons {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
            overflow: hidden;
        }

        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f7fafc;
            border-radius: 15px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-btn:hover:not(.active) {
            background: #e2e8f0;
            color: #374156;
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .main {
                padding: 10px 15px;
            }

            .button-group {
                grid-template-columns: 1fr;
                margin-bottom: 15px;
            }

            .craving-button, .vaped-button {
                height: 60px;
            }

            .add-past-btn {
                padding: 10px;
                margin-bottom: 15px;
                font-size: 13px;
            }

            .data-controls {
                margin-bottom: 15px !important;
            }

            .entry-time {
                font-size: 13px;
            }

            .entry-type {
                font-size: 10px;
                padding: 2px 6px;
            }

            .edit-btn, .delete-btn {
                padding: 3px 6px;
                font-size: 11px;
                min-width: 24px;
            }

            .entry-header {
                gap: 8px;
            }

            .entry {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>Quit Tracker</h1>
                    <p>Track your progress, one step at a time</p>
                </div>
                <div class="burger-menu">
                    <button class="burger-icon" id="burgerBtn">‚ò∞</button>
                    <div class="burger-dropdown" id="burgerDropdown">
                        <div class="burger-header">
                            <button class="burger-close" id="burgerCloseBtn">‚úï</button>
                        </div>
                        <div class="burger-section">
                            <h4>Data Management</h4>
                            <div class="burger-buttons">
                                <button class="burger-btn export" id="burgerExportBtn">
                                    üì§ Export Data
                                </button>
                                <button class="burger-btn import" id="burgerImportBtn">
                                    üì• Import Data
                                </button>
                                <button class="burger-btn update" id="burgerUpdateBtn">
                                    üîÑ Update App
                                </button>
                            </div>
                        </div>
                        <div class="burger-section">
                            <h4>Category Visibility</h4>
                            <div class="category-toggles">
                                <div class="toggle-item">
                                    <div class="toggle-label">
                                        <span>üí®</span>
                                        <span>Vaping</span>
                                    </div>
                                    <div class="toggle-switch active" id="vapingToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-label">
                                        <span>üç∑</span>
                                        <span>Alcohol</span>
                                    </div>
                                    <div class="toggle-switch active" id="alcoholToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="burger-section">
                             <h4>Display Options</h4>
                             <div class="category-toggles">
                                 <div class="toggle-item">
                                     <div class="toggle-label">
                                         <span>üìù</span>
                                         <span>Show Notes</span>
                                     </div>
                                     <div class="toggle-switch active" id="notesToggle">
                                         <div class="toggle-slider"></div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-group">
                    <h4 id="cravingsLabel">Vape Cravings</h4>
                    <div class="stat-row">
                        <div class="stat">
                            <div class="stat-number" id="todayCravings">0</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="totalCravings">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>
                <div class="stat-group">
                    <h4 id="freeTimeLabel">Vape Free</h4>
                    <div class="smoke-free-time" id="smokeFreeTime">0d 0h</div>
                    <div class="stat-row">
                        <div class="stat">
                            <div class="stat-number" id="totalSmoked">0</div>
                            <div class="stat-label" id="totalConsumedLabel">Total Vaped</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="todayBtn">üìä Today</button>
                <button class="nav-btn" id="timelineBtn">üìà Timeline</button>
            </div>
        </div>

        <div class="main">
            <div class="success-message" id="successMessage"></div>
            <div class="warning-message" id="warningMessage"></div>

            <!-- Category Tabs -->
            <div class="category-tabs">
                <button class="tab-btn active" data-category="vaping" id="vapingTab">
                    üí® Vaping
                </button>
                <button class="tab-btn" data-category="alcohol" id="alcoholTab">
                    üç∑ Alcohol
                </button>
            </div>

            <div class="button-group">
                <button class="craving-button" id="cravingBtn">
                    üò£ Had a Craving
                </button>
                <button class="vaped-button" id="smokedBtn">
                    üí® I Vaped
                </button>
            </div>

            <button class="add-past-btn" id="addPastBtn">
                üìÖ Add Past Entry
            </button>

            <input type="file" id="importFile" accept=".json" style="display: none;">
            <div class="burger-overlay" id="burgerOverlay"></div>

            <div class="history">
                <div class="history-header">
                    <h3>Today's Activity</h3>
                    <button class="clear-btn" id="clearBtn" style="display: none;">Clear All</button>
                </div>
                <div id="entryHistory">
                    <div class="empty-state">
                        No entries recorded yet. When you log your first entry, it will appear here.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <h3 id="entryModalTitle">Add Entry</h3>
            <form id="entryForm">
                <div class="form-group">
                    <label for="entryType">Type:</label>
                    <select id="entryType" required>
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Vaped</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entryDate">Date:</label>
                    <input type="date" id="entryDate" required>
                </div>
                <div class="form-group">
                    <label for="entryTime">Time:</label>
                    <input type="time" id="entryTime" required>
                </div>
                <div class="form-group" id="intensityGroup">
                    <label for="entryIntensity">Craving Intensity:</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="entryIntensity" min="1" max="3" value="2" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">Mild</span>
                            <span class="intensity-label">Medium</span>
                            <span class="intensity-label">Strong</span>
                        </div>
                        <div class="intensity-value" id="intensityValue">Medium</div>
                    </div>
                </div>
                <div class="form-group" id="costGroup" style="display: none;">
                    <label for="entryCost">Cost:</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="entryCost" min="0" max="40" step="1" value="0" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">¬£0</span>
                            <span class="intensity-label">¬£5</span>
                            <span class="intensity-label">¬£10</span>
                        </div>
                        <div class="intensity-value" id="costValue">¬£0.00</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="entryNote">Note (optional):</label>
                    <textarea id="entryNote" placeholder="Add details about this entry (triggers, feelings, situation, etc.)..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelEntryBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitEntryBtn">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Entry</h3>
            <form id="editEntryForm">
                <div class="form-group">
                    <label for="editEntryType">Type:</label>
                    <select id="editEntryType" required>
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Vaped</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editEntryDate">Date:</label>
                    <input type="date" id="editEntryDate" required>
                </div>
                <div class="form-group">
                    <label for="editEntryTime">Time:</label>
                    <input type="time" id="editEntryTime" required>
                </div>
                <div class="form-group" id="editIntensityGroup">
                    <label for="editIntensity">Craving Intensity (optional):</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="editIntensity" min="1" max="3" value="2" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">Mild</span>
                            <span class="intensity-label">Medium</span>
                            <span class="intensity-label">Strong</span>
                        </div>
                        <div class="intensity-value" id="editIntensityValue">Medium</div>
                    </div>
                </div>
                <div class="form-group" id="editCostGroup" style="display: none;">
                    <label for="editCost">Cost:</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="editCost" min="0" max="40" step="1" value="0" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">¬£0</span>
                            <span class="intensity-label">¬£5</span>
                            <span class="intensity-label">¬£10</span>
                        </div>
                        <div class="intensity-value" id="editCostValue">¬£0.00</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editNote">Note (optional):</label>
                    <textarea id="editNote" placeholder="Add details about this entry..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="shared-modal.js"></script>
    <script>
        // Service Worker Registration with improved caching
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'quit-tracker-v3';
                const urlsToCache = ['/'];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                            .then(() => self.skipWaiting())
                    );
                });

                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        }).then(() => self.clients.claim())
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request).then(response => {
                                    if (!response || response.status !== 200 || response.type !== 'basic') {
                                        return response;
                                    }
                                    const responseToCache = response.clone();
                                    caches.open(CACHE_NAME)
                                        .then(cache => {
                                            cache.put(event.request, responseToCache);
                                        });
                                    return response;
                                });
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => {
                    console.log('Service Worker registered with improved caching');
                    URL.revokeObjectURL(swUrl);
                })
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // IndexedDB wrapper for persistent storage
        class DataStore {
            constructor() {
                this.dbName = 'QuitTrackerDB';
                this.version = 1;
                this.storeName = 'entries';
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('type', 'type', { unique: false });
                        }
                    };
                });
            }

            async saveEntries(entries) {
                if (!this.db) await this.init();
                
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                
                // Clear existing entries and add new ones
                await store.clear();
                for (const entry of entries) {
                    await store.add(entry);
                }
                
                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            }

            async loadEntries() {
                if (!this.db) await this.init();
                
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const entries = request.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        resolve(entries);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async exportData() {
                const entries = await this.loadEntries();
                const exportData = {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    entries: entries
                };
                return JSON.stringify(exportData, null, 2);
            }

            async importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.entries && Array.isArray(data.entries)) {
                        await this.saveEntries(data.entries);
                        return data.entries.length;
                    }
                    throw new Error('Invalid data format');
                } catch (error) {
                    throw new Error('Failed to import data: ' + error.message);
                }
            }
        }

        class QuitTracker {
            constructor() {
                this.dataStore = new DataStore();
                this.entries = [];
                this.currentCategory = 'vaping'; // Track current active category
                this.categoryVisibility = {
                    vaping: true,
                    alcohol: true
                };
                 this.showNotes = true;
                this.updatingVisibility = false;
                this.initializeElements();
                this.bindEvents();
                this.initializeApp();
            }

            async initializeApp() {
                try {
                    // Check for update backup first
                    const updateBackup = localStorage.getItem('quitTrackerUpdateBackup');
                    if (updateBackup) {
                        try {
                            await this.dataStore.importData(updateBackup);
                            localStorage.removeItem('quitTrackerUpdateBackup');
                            this.showMessage('success', 'Your data has been restored after the update! üéâ');
                        } catch (error) {
                            console.error('Failed to restore update backup:', error);
                        }
                    }
                    
                    // Try to load from IndexedDB first
                    this.entries = await this.dataStore.loadEntries();
                    
                    // If no data in IndexedDB, check localStorage for migration
                    if (this.entries.length === 0) {
                        const localStorageData = this.loadFromLocalStorage();
                        if (localStorageData.length > 0) {
                            await this.dataStore.saveEntries(localStorageData);
                            this.entries = localStorageData;
                            console.log('Migrated data from localStorage to IndexedDB');
                        }
                    }
                } catch (error) {
                    console.error('Failed to load from IndexedDB, falling back to localStorage:', error);
                    this.entries = this.loadFromLocalStorage();
                }
                
                // Handle legacy entries - add missing fields for backward compatibility
                let hasLegacyEntries = false;
                this.entries.forEach(entry => {
                    let entryModified = false;
                    
                    // Add default intensity for craving entries without it
                    if (entry.type === 'craving' && entry.intensity === undefined) {
                        entry.intensity = 2; // Default to medium intensity
                        entryModified = true;
                    }
                    
                    // Add default category for entries without it (all existing entries are vaping-related)
                    if (entry.category === undefined) {
                        entry.category = 'vaping';
                        entryModified = true;
                    }
                    
                    if (entryModified) {
                        hasLegacyEntries = true;
                    }
                });
                
                // Save updated entries if we modified any legacy entries
                if (hasLegacyEntries) {
                    try {
                        await this.saveEntries();
                        console.log('Updated legacy entries with default intensity values');
                    } catch (error) {
                        console.error('Failed to save legacy entry updates:', error);
                    }
                }
                
                this.loadCategoryVisibilitySettings(); // Load category visibility settings
                this.loadNotesSetting();
                this.updateButtonsForCategory(); // Initialize buttons for default category
                this.updateStats();
                this.renderHistory();
                this.updateCategoryVisibility(); // Apply visibility settings
                this.updateNotesToggleUI();
            }

            initializeElements() {
                this.cravingBtn = document.getElementById('cravingBtn');
                this.smokedBtn = document.getElementById('smokedBtn');
                this.successMessage = document.getElementById('successMessage');
                this.warningMessage = document.getElementById('warningMessage');
                this.historyContainer = document.getElementById('entryHistory');
                this.clearBtn = document.getElementById('clearBtn');
                this.addPastBtn = document.getElementById('addPastBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.importBtn = document.getElementById('importBtn');
                this.importFile = document.getElementById('importFile');
                this.updateBtn = document.getElementById('updateBtn');
                this.todayBtn = document.getElementById('todayBtn');
                this.timelineBtn = document.getElementById('timelineBtn');
                
                // Burger menu elements
                this.burgerBtn = document.getElementById('burgerBtn');
                this.burgerDropdown = document.getElementById('burgerDropdown');
                this.burgerOverlay = document.getElementById('burgerOverlay');
                this.burgerCloseBtn = document.getElementById('burgerCloseBtn');
                this.burgerExportBtn = document.getElementById('burgerExportBtn');
                this.burgerImportBtn = document.getElementById('burgerImportBtn');
                this.burgerUpdateBtn = document.getElementById('burgerUpdateBtn');
                this.vapingToggle = document.getElementById('vapingToggle');
                this.alcoholToggle = document.getElementById('alcoholToggle');
                this.notesToggle = document.getElementById('notesToggle');
                
                // Tab elements
                this.vapingTab = document.getElementById('vapingTab');
                this.alcoholTab = document.getElementById('alcoholTab');
                
                // Stats elements
                this.todayCravings = document.getElementById('todayCravings');
                this.totalCravings = document.getElementById('totalCravings');
                this.totalSmoked = document.getElementById('totalSmoked');
                this.smokeFreeTime = document.getElementById('smokeFreeTime');
                this.cravingsLabel = document.getElementById('cravingsLabel');
                this.freeTimeLabel = document.getElementById('freeTimeLabel');
                this.totalConsumedLabel = document.getElementById('totalConsumedLabel');
                
                // Modal elements
                this.entryModal = document.getElementById('entryModal');
                this.entryForm = document.getElementById('entryForm');
                this.entryModalTitle = document.getElementById('entryModalTitle');
                this.submitEntryBtn = document.getElementById('submitEntryBtn');
                this.cancelEntryBtn = document.getElementById('cancelEntryBtn');
                this.editEntryModal = document.getElementById('editEntryModal');
                this.editEntryForm = document.getElementById('editEntryForm');
                this.cancelEditBtn = document.getElementById('cancelEditBtn');
                this.currentEditingId = null;
                this.isEditMode = false;
                
                // Intensity slider elements
                this.intensitySlider = document.getElementById('entryIntensity');
                this.intensityValue = document.getElementById('intensityValue');
                this.intensityGroup = document.getElementById('intensityGroup');
                this.editIntensitySlider = document.getElementById('editIntensity');
                this.editIntensityValue = document.getElementById('editIntensityValue');
                this.editIntensityGroup = document.getElementById('editIntensityGroup');
                
                // Cost slider elements
                this.costSlider = document.getElementById('entryCost');
                this.costValue = document.getElementById('costValue');
                this.costGroup = document.getElementById('costGroup');
                this.editCostSlider = document.getElementById('editCost');
                this.editCostValue = document.getElementById('editCostValue');
                this.editCostGroup = document.getElementById('editCostGroup');
            }

            bindEvents() {
                this.cravingBtn.addEventListener('click', () => this.showEntryModal('craving'));
                this.smokedBtn.addEventListener('click', () => this.showEntryModal('smoked'));
                this.clearBtn.addEventListener('click', () => this.clearHistory());
                this.addPastBtn.addEventListener('click', () => this.showEntryModal(null, true));
                this.burgerExportBtn.addEventListener('click', () => this.exportData());
                this.burgerImportBtn.addEventListener('click', () => this.importFile.click());
                this.importFile.addEventListener('change', (e) => this.importData(e));
                this.burgerUpdateBtn.addEventListener('click', () => this.updateApp());
                this.timelineBtn.addEventListener('click', () => window.location.href = 'timeline.html');
                this.cancelEntryBtn.addEventListener('click', () => this.hideEntryModal());
                this.entryForm.addEventListener('submit', (e) => this.handleEntrySubmit(e));
                this.cancelEditBtn.addEventListener('click', () => this.hideEditEntryModal());
                this.editEntryForm.addEventListener('submit', (e) => this.handleEditEntrySubmit(e));
                
                // Tab event listeners
                this.vapingTab.addEventListener('click', () => this.switchCategory('vaping'));
                this.alcoholTab.addEventListener('click', () => this.switchCategory('alcohol'));
                
                // Close modal when clicking outside
                this.entryModal.addEventListener('click', (e) => {
                    if (e.target === this.entryModal) {
                        this.hideEntryModal();
                    }
                });
                
                this.editEntryModal.addEventListener('click', (e) => {
                    if (e.target === this.editEntryModal) {
                        this.hideEditEntryModal();
                    }
                });
                
                // Intensity slider events
                this.intensitySlider.addEventListener('input', (e) => this.updateIntensityLabel(e.target.value, this.intensityValue));
                this.editIntensitySlider.addEventListener('input', (e) => this.updateIntensityLabel(e.target.value, this.editIntensityValue));
                
                // Cost slider events
                this.costSlider.addEventListener('input', (e) => this.updateCostLabel(e.target.value, this.costValue));
                this.editCostSlider.addEventListener('input', (e) => this.updateCostLabel(e.target.value, this.editCostValue));
                
                // Entry type change events to show/hide appropriate sliders
                document.getElementById('entryType').addEventListener('change', (e) => this.handleEntryTypeChange(e));
                document.getElementById('editEntryType').addEventListener('change', (e) => this.handleEditEntryTypeChange(e));
                
                // Burger menu events
                this.burgerBtn.addEventListener('click', () => this.toggleBurgerMenu());
                this.burgerOverlay.addEventListener('click', () => this.closeBurgerMenu());
                this.burgerCloseBtn.addEventListener('click', () => this.closeBurgerMenu());
                this.vapingToggle.addEventListener('click', () => this.toggleCategoryVisibility('vaping'));
                this.alcoholToggle.addEventListener('click', () => this.toggleCategoryVisibility('alcohol'));
                if (this.notesToggle) {
                    this.notesToggle.addEventListener('click', () => this.toggleNotesVisibility());
                }
            }

            switchCategory(category) {
                this.currentCategory = category;
                
                // Update tab appearance
                this.vapingTab.classList.toggle('active', category === 'vaping');
                this.alcoholTab.classList.toggle('active', category === 'alcohol');
                
                // Update buttons and UI for selected category
                this.updateButtonsForCategory();
                this.updateStats();
                this.renderHistory();
            }

            updateButtonsForCategory() {
                if (this.currentCategory === 'vaping') {
                    this.cravingBtn.innerHTML = 'üò£ Had a Craving';
                    this.smokedBtn.innerHTML = 'üí® I Vaped';
                    this.smokedBtn.style.background = 'linear-gradient(45deg, #2d3748, #4a5568)';
                    this.cravingsLabel.textContent = 'Vape Cravings';
                    this.freeTimeLabel.textContent = 'Vape Free';
                    this.totalConsumedLabel.textContent = 'Total Vaped';
                } else {
                    this.cravingBtn.innerHTML = 'ü§î Had a Craving';
                    this.smokedBtn.innerHTML = 'üç∑ I Drank';
                    this.smokedBtn.style.background = 'linear-gradient(45deg, #b83280, #d69e2e)';
                    this.cravingsLabel.textContent = 'Alcohol Cravings';
                    this.freeTimeLabel.textContent = 'Alcohol Free';
                    this.totalConsumedLabel.textContent = 'Total Drinks';
                }
                
                // Update modal options
                this.updateModalOptions();
                
                // Update UI based on category visibility
                this.updateCategoryVisibility();
            }

            updateModalOptions() {
                const entryTypeSelect = document.getElementById('entryType');
                const editEntryTypeSelect = document.getElementById('editEntryType');
                
                if (this.currentCategory === 'vaping') {
                    entryTypeSelect.innerHTML = `
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Vaped</option>
                    `;
                    editEntryTypeSelect.innerHTML = `
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Vaped</option>
                    `;
                } else {
                    entryTypeSelect.innerHTML = `
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Drank</option>
                    `;
                    editEntryTypeSelect.innerHTML = `
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Drank</option>
                    `;
                }
            }

            updateIntensityLabel(value, labelElement) {
                const labels = ['', 'Mild', 'Medium', 'Strong'];
                labelElement.textContent = labels[parseInt(value)];
            }

            updateCostLabel(value, labelElement) {
                // Convert from 0-40 range to ¬£0-¬£10 in ¬£0.25 increments
                const cost = (parseInt(value) * 0.25).toFixed(2);
                labelElement.textContent = `¬£${cost}`;
            }

            handleEntryTypeChange(e) {
                const type = e.target.value;
                
                // Show/hide intensity slider for cravings
                if (type === 'craving') {
                    this.intensityGroup.style.display = 'block';
                    this.intensitySlider.value = 2;
                    this.updateIntensityLabel(2, this.intensityValue);
                } else {
                    this.intensityGroup.style.display = 'none';
                }
                
                // Show/hide cost slider for alcohol consumption
                if (type === 'smoked' && this.currentCategory === 'alcohol') {
                    this.costGroup.style.display = 'block';
                    this.costSlider.value = 0;
                    this.updateCostLabel(0, this.costValue);
                } else {
                    this.costGroup.style.display = 'none';
                }
            }

            handleEditEntryTypeChange(e) {
                const type = e.target.value;
                
                // Show/hide intensity slider for cravings
                if (type === 'craving') {
                    this.editIntensityGroup.style.display = 'block';
                } else {
                    this.editIntensityGroup.style.display = 'none';
                }
                
                // Show/hide cost slider for alcohol consumption
                if (type === 'smoked' && this.currentCategory === 'alcohol') {
                    this.editCostGroup.style.display = 'block';
                } else {
                    this.editCostGroup.style.display = 'none';
                }
            }

            showEntryModal(type = null, isPastEntry = false) {
                const now = new Date();
                
                // Set modal title and button text
                if (isPastEntry) {
                    this.entryModalTitle.textContent = 'Add Past Entry';
                    this.submitEntryBtn.textContent = 'Add Entry';
                } else {
                    if (type === 'craving') {
                        this.entryModalTitle.textContent = this.currentCategory === 'vaping' ? 'Record Vape Craving' : 'Record Alcohol Craving';
                    } else {
                        this.entryModalTitle.textContent = this.currentCategory === 'vaping' ? 'Record Vaping' : 'Record Drink';
                    }
                    this.submitEntryBtn.textContent = 'Save Entry';
                }
                
                // Show/hide intensity slider based on entry type
                if (type === 'craving' || (isPastEntry && !type)) {
                    this.intensityGroup.style.display = 'block';
                    this.intensitySlider.value = 2;
                    this.updateIntensityLabel(2, this.intensityValue);
                } else {
                    this.intensityGroup.style.display = 'none';
                }
                
                // Show/hide cost slider based on category and entry type
                if ((type === 'smoked' || (isPastEntry && !type)) && this.currentCategory === 'alcohol') {
                    this.costGroup.style.display = 'block';
                    this.costSlider.value = 0;
                    this.updateCostLabel(0, this.costValue);
                } else {
                    this.costGroup.style.display = 'none';
                }
                
                // Pre-fill form
                if (type) {
                    document.getElementById('entryType').value = type;
                }
                document.getElementById('entryDate').value = now.toISOString().split('T')[0];
                document.getElementById('entryTime').value = now.toTimeString().slice(0,5);
                document.getElementById('entryNote').value = '';
                
                this.isEditMode = false;
                this.entryModal.style.display = 'block';
            }

            hideEntryModal() {
                this.entryModal.style.display = 'none';
                this.entryForm.reset();
                this.isEditMode = false;
            }

            async handleEntrySubmit(e) {
                e.preventDefault();
                
                const type = document.getElementById('entryType').value;
                const date = document.getElementById('entryDate').value;
                const time = document.getElementById('entryTime').value;
                const note = document.getElementById('entryNote').value.trim();
                
                const timestamp = new Date(`${date}T${time}`);
                
                if (timestamp > new Date()) {
                    alert('Cannot add future entries!');
                    return;
                }
                
                const entry = {
                    id: Date.now(),
                    category: this.currentCategory,
                    type: type,
                    timestamp: timestamp.toISOString(),
                    note: note,
                    date: timestamp.toDateString(),
                    intensity: type === 'craving' ? parseInt(document.getElementById('entryIntensity').value) : null,
                    cost: (type === 'smoked' && this.currentCategory === 'alcohol') ? (parseInt(document.getElementById('entryCost').value) * 0.25) : null
                };

                this.entries.push(entry);
                this.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                await this.saveEntries();
                this.hideEntryModal();
                
                if (type === 'craving') {
                    this.showMessage('success', 'Craving recorded! Stay strong! üí™');
                } else {
                    const actionMessage = this.currentCategory === 'vaping' ? 
                        'Vaping logged. Remember: every quit attempt gets you closer to success! üåü' :
                        'Drink logged. Remember: every quit attempt gets you closer to success! üåü';
                    this.showMessage('warning', actionMessage);
                }
                
                this.updateStats();
                this.renderHistory();
            }


            showEditEntryModal(entry) {
                this.currentEditingId = entry.id;
                const entryDate = new Date(entry.timestamp);
                
                document.getElementById('editEntryType').value = entry.type;
                document.getElementById('editEntryDate').value = entryDate.toISOString().split('T')[0];
                document.getElementById('editEntryTime').value = entryDate.toTimeString().slice(0,5);
                document.getElementById('editNote').value = entry.note || '';
                
                // Handle intensity for craving entries
                const editIntensityGroup = document.getElementById('editIntensityGroup');
                if (entry.type === 'craving') {
                    editIntensityGroup.style.display = 'block';
                    const intensityValue = entry.intensity || 2; // Default to 2 for legacy entries
                    document.getElementById('editIntensity').value = intensityValue;
                    this.updateIntensityLabel(intensityValue, this.editIntensityValue);
                } else {
                    editIntensityGroup.style.display = 'none';
                }
                
                // Handle cost for alcohol consumption entries
                const editCostGroup = document.getElementById('editCostGroup');
                if (entry.type === 'smoked' && entry.category === 'alcohol') {
                    editCostGroup.style.display = 'block';
                    const costValue = entry.cost ? Math.round(entry.cost / 0.25) : 0; // Convert back to slider range (0-40)
                    document.getElementById('editCost').value = costValue;
                    this.updateCostLabel(costValue, this.editCostValue);
                } else {
                    editCostGroup.style.display = 'none';
                }
                
                this.editEntryModal.style.display = 'block';
            }

            hideEditEntryModal() {
                this.editEntryModal.style.display = 'none';
                this.editEntryForm.reset();
                this.currentEditingId = null;
            }

            async handleEditEntrySubmit(e) {
                e.preventDefault();
                
                const type = document.getElementById('editEntryType').value;
                const date = document.getElementById('editEntryDate').value;
                const time = document.getElementById('editEntryTime').value;
                const note = document.getElementById('editNote').value.trim();
                
                const timestamp = new Date(`${date}T${time}`);
                
                if (timestamp > new Date()) {
                    alert('Cannot set future date/time!');
                    return;
                }
                
                // Find and update the entry
                const entryIndex = this.entries.findIndex(e => e.id === this.currentEditingId);
                if (entryIndex === -1) {
                    alert('Entry not found!');
                    return;
                }
                
                this.entries[entryIndex] = {
                    ...this.entries[entryIndex],
                    type: type,
                    timestamp: timestamp.toISOString(),
                    note: note,
                    date: timestamp.toDateString(),
                    intensity: type === 'craving' ? parseInt(document.getElementById('editIntensity').value) : null,
                    cost: (type === 'smoked' && this.entries[entryIndex].category === 'alcohol') ? (parseInt(document.getElementById('editCost').value) * 0.25) : null
                };
                
                // Re-sort entries by timestamp
                this.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                await this.saveEntries();
                this.hideEditEntryModal();
                
                this.showMessage('success', 'Entry updated successfully!');
                this.updateStats();
                this.renderHistory();
            }

            editEntry(id) {
                const entry = this.entries.find(e => e.id === id);
                if (entry) {
                    this.showEditEntryModal(entry);
                }
            }

            async deleteEntry(id) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    this.entries = this.entries.filter(entry => entry.id !== id);
                    await this.saveEntries();
                    this.updateStats();
                    this.renderHistory();
                }
            }

            showMessage(type, text) {
                const messageEl = type === 'success' ? this.successMessage : this.warningMessage;
                messageEl.textContent = text;
                messageEl.classList.add('show');
                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 4000);
            }

            updateStats() {
                const today = new Date().toDateString();
                const todayCravings = this.entries.filter(e => e.date === today && e.type === 'craving' && e.category === this.currentCategory);
                const totalCravings = this.entries.filter(e => e.type === 'craving' && e.category === this.currentCategory);
                const totalVaped = this.entries.filter(e => e.type === 'smoked' && e.category === this.currentCategory);
                
                this.todayCravings.textContent = todayCravings.length;
                this.totalCravings.textContent = totalCravings.length;
                this.totalSmoked.textContent = totalVaped.length;
                
                // Calculate vape-free time
                const lastVaped = totalVaped.length > 0 
                    ? new Date(totalVaped[0].timestamp) 
                    : null;
                
                if (lastVaped) {
                    const timeDiff = Date.now() - lastVaped.getTime();
                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (days > 0) {
                        this.smokeFreeTime.textContent = `${days}d ${hours}h`;
                    } else if (hours > 0) {
                        this.smokeFreeTime.textContent = `${hours}h ${minutes}m`;
                    } else {
                        this.smokeFreeTime.textContent = '0d 0h';
                    }
                }
            }

            renderHistory() {
                // Filter entries to show only today's entries for the current category
                const today = new Date().toDateString();
                const todaysEntries = this.entries.filter(entry => entry.date === today && entry.category === this.currentCategory);
                
                if (todaysEntries.length === 0) {
                    this.historyContainer.innerHTML = `
                        <div class="empty-state">
                            No entries recorded today for ${this.currentCategory}. When you log an entry today, it will appear here.
                        </div>
                    `;
                    this.clearBtn.style.display = 'none';
                    return;
                }

                this.clearBtn.style.display = 'block';
                
                const historyHTML = todaysEntries.map(entry => {
                    const date = new Date(entry.timestamp);
                    const timeString = date.toLocaleString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });

                    const typeClass = entry.type === 'craving' ? 'craving-entry' : 'vaped-entry';
                    const typeLabel = entry.type === 'craving' ? 'CRAVING' : 
                                    (entry.category === 'vaping' ? 'VAPED' : 'DRANK');
                    const typeColor = entry.type === 'craving' ? 'craving' : 'vaped';
                    
                    // Format cost display for alcohol entries
                    const costDisplay = (entry.type === 'smoked' && entry.category === 'alcohol' && entry.cost !== null && entry.cost > 0) 
                        ? `<div class="entry-cost">¬£${entry.cost.toFixed(2)}</div>` 
                        : '';

                    return `
                        <div class="entry ${typeClass}">
                            <div class="entry-header">
                                <div class="entry-time">${timeString}</div>
                                <div class="entry-actions">
                                    <span class="entry-type ${typeColor}">${typeLabel}</span>
                                    <button class="edit-btn" onclick="app.editEntry(${entry.id})" title="Edit entry">‚úèÔ∏è</button>
                                    <button class="delete-btn" onclick="app.deleteEntry(${entry.id})" title="Delete entry">√ó</button>
                                </div>
                            </div>
                            ${costDisplay}
                            ${this.showNotes && entry.note ? `<div class="entry-note">"${entry.note}"</div>` : ''}
                        </div>
                    `;
                }).join('');

                this.historyContainer.innerHTML = historyHTML;
            }

            // Notes visibility preference
            loadNotesSetting() {
                try {
                    const saved = localStorage.getItem('showNotes');
                    if (saved !== null) {
                        this.showNotes = JSON.parse(saved) === true;
                    }
                } catch (e) {
                    this.showNotes = true;
                }
            }

            saveNotesSetting() {
                try {
                    localStorage.setItem('showNotes', JSON.stringify(this.showNotes));
                } catch (e) {
                    // noop
                }
            }

            updateNotesToggleUI() {
                if (this.notesToggle) {
                    this.notesToggle.classList.toggle('active', this.showNotes === true);
                }
            }

            toggleNotesVisibility() {
                this.showNotes = !this.showNotes;
                this.saveNotesSetting();
                this.updateNotesToggleUI();
                this.renderHistory();
            }

            async clearHistory() {
                if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                    this.entries = [];
                    await this.saveEntries();
                    this.updateStats();
                    this.renderHistory();
                    this.showMessage('success', 'All history cleared.');
                }
            }

            loadFromLocalStorage() {
                try {
                    const stored = JSON.parse(localStorage.getItem('quitTrackerEntries') || '[]');
                    return stored.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } catch (e) {
                    return [];
                }
            }

            async saveEntries() {
                try {
                    await this.dataStore.saveEntries(this.entries);
                    // Also save to localStorage as fallback
                    localStorage.setItem('quitTrackerEntries', JSON.stringify(this.entries));
                } catch (error) {
                    console.error('Failed to save to IndexedDB, using localStorage only:', error);
                    localStorage.setItem('quitTrackerEntries', JSON.stringify(this.entries));
                }
            }

            async exportData() {
                try {
                    const exportData = await this.dataStore.exportData();
                    const blob = new Blob([exportData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `quit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    this.showMessage('success', 'Data exported successfully! üì§');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showMessage('warning', 'Export failed. Please try again.');
                }
            }

            async importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const importedCount = await this.dataStore.importData(text);
                    this.entries = await this.dataStore.loadEntries();
                    this.updateStats();
                    this.renderHistory();
                    this.showMessage('success', `Successfully imported ${importedCount} entries! üì•`);
                } catch (error) {
                    console.error('Import failed:', error);
                    this.showMessage('warning', 'Import failed. Please check the file format.');
                } finally {
                    event.target.value = '';
                }
            }

            async updateApp() {
                if (!confirm('This will refresh the page to load the latest version from GitHub Pages. Continue?')) {
                    return;
                }

                this.burgerUpdateBtn.disabled = true;
                this.burgerUpdateBtn.textContent = '‚è≥ Refreshing...';
                
                // Simple page refresh - GitHub Pages automatically serves the latest version
                setTimeout(() => {
                    location.reload();
                }, 500);
            }

            toggleBurgerMenu() {
                const isOpen = this.burgerDropdown.classList.contains('show');
                if (isOpen) {
                    this.closeBurgerMenu();
                } else {
                    this.openBurgerMenu();
                }
            }

            openBurgerMenu() {
                // Position the dropdown relative to the burger button
                const burgerRect = this.burgerBtn.getBoundingClientRect();
                this.burgerDropdown.style.top = `${burgerRect.bottom + 5}px`;
                this.burgerDropdown.style.right = `${window.innerWidth - burgerRect.right}px`;
                
                this.burgerDropdown.classList.add('show');
                this.burgerOverlay.classList.add('show');
            }

            closeBurgerMenu() {
                this.burgerDropdown.classList.remove('show');
                this.burgerOverlay.classList.remove('show');
            }

            toggleCategoryVisibility(category) {
                // Prevent rapid clicking
                if (this.updatingVisibility) {
                    return;
                }
                
                this.updatingVisibility = true;
                
                try {
                    this.categoryVisibility[category] = !this.categoryVisibility[category];
                    this.saveCategoryVisibilitySettings();
                    this.updateCategoryVisibility();
                    this.updateStats();
                    this.renderHistory();
                } catch (error) {
                    console.error('Error toggling category visibility:', error);
                } finally {
                    // Clear the flag after a short delay
                    setTimeout(() => {
                        this.updatingVisibility = false;
                    }, 100);
                }
            }

            updateCategoryVisibility(skipInterfaceRestore = false) {
                const visibleCategories = Object.values(this.categoryVisibility).filter(visible => visible).length;
                const isEmptyState = document.querySelector('.main .empty-state') !== null && !document.querySelector('.category-tabs');
                
                // Show/hide header stats based on category visibility
                const statsSection = document.querySelector('.stats');
                if (statsSection) {
                    statsSection.style.display = visibleCategories > 0 ? 'grid' : 'none';
                }
                
                // If transitioning from empty state to having visible categories, restore the interface
                if (!skipInterfaceRestore && isEmptyState && visibleCategories > 0) {
                    this.restoreFullInterface();
                    return;
                }
                
                // If no categories are visible, show empty state for main content only
                if (visibleCategories === 0) {
                    this.showEmptyState();
                    return;
                }
                
                // Update toggle switches if they exist
                if (this.vapingToggle && this.alcoholToggle) {
                    this.vapingToggle.classList.toggle('active', this.categoryVisibility.vaping);
                    this.alcoholToggle.classList.toggle('active', this.categoryVisibility.alcohol);
                }

                // Get category tabs
                const categoryTabs = document.querySelector('.category-tabs');
                
                // Show/hide tabs based on visibility settings
                const vapingTab = document.getElementById('vapingTab');
                const alcoholTab = document.getElementById('alcoholTab');
                
                if (vapingTab && alcoholTab) {
                    vapingTab.style.display = this.categoryVisibility.vaping ? 'flex' : 'none';
                    alcoholTab.style.display = this.categoryVisibility.alcohol ? 'flex' : 'none';
                }
                
                // If current category is hidden, switch to a visible one
                if (!this.categoryVisibility[this.currentCategory]) {
                    if (this.categoryVisibility.vaping) {
                        this.switchCategory('vaping');
                    } else if (this.categoryVisibility.alcohol) {
                        this.switchCategory('alcohol');
                    }
                }
                
                // Hide entire tabs section if only one category is visible
                if (categoryTabs) {
                    categoryTabs.style.display = visibleCategories > 1 ? 'flex' : 'none';
                }
                
                // If only one category is visible, auto-switch to it
                if (visibleCategories === 1) {
                    const visibleCategory = Object.keys(this.categoryVisibility).find(cat => this.categoryVisibility[cat]);
                    if (visibleCategory && this.currentCategory !== visibleCategory) {
                        this.switchCategory(visibleCategory);
                    }
                }
            }

            showEmptyState() {
                const main = document.querySelector('.main');
                main.innerHTML = `
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <div class="burger-overlay" id="burgerOverlay"></div>
                    <div class="empty-state" style="padding: 60px 20px; text-align: center;">
                        <h3 style="color: #a0aec0; margin-bottom: 15px;">No Categories Enabled</h3>
                        <p style="color: #a0aec0;">Enable at least one category in the menu (‚ò∞) to start tracking.</p>
                    </div>
                `;
                // Re-bind the import file event since the element was recreated
                this.importFile = document.getElementById('importFile');
                this.burgerOverlay = document.getElementById('burgerOverlay');
                this.importFile.addEventListener('change', (e) => this.importData(e));
                this.burgerOverlay.addEventListener('click', () => this.closeBurgerMenu());
                
                // Update toggle references and visual state
                this.vapingToggle = document.getElementById('vapingToggle');
                this.alcoholToggle = document.getElementById('alcoholToggle');
                if (this.vapingToggle && this.alcoholToggle) {
                    this.vapingToggle.classList.toggle('active', this.categoryVisibility.vaping);
                    this.alcoholToggle.classList.toggle('active', this.categoryVisibility.alcohol);
                }
            }

            restoreFullInterface() {
                const main = document.querySelector('.main');
                main.innerHTML = `
                    <div class="success-message" id="successMessage"></div>
                    <div class="warning-message" id="warningMessage"></div>

                    <!-- Category Tabs -->
                    <div class="category-tabs">
                        <button class="tab-btn active" data-category="vaping" id="vapingTab">
                            üí® Vaping
                        </button>
                        <button class="tab-btn" data-category="alcohol" id="alcoholTab">
                            üç∑ Alcohol
                        </button>
                    </div>

                    <div class="button-group">
                        <button class="craving-button" id="cravingBtn">
                            üò£ Had a Craving
                        </button>
                        <button class="vaped-button" id="smokedBtn">
                            üí® I Vaped
                        </button>
                    </div>

                    <button class="add-past-btn" id="addPastBtn">
                        üìÖ Add Past Entry
                    </button>

                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <div class="burger-overlay" id="burgerOverlay"></div>

                    <div class="history">
                        <div class="history-header">
                            <h3>Today's Activity</h3>
                            <button class="clear-btn" id="clearBtn" style="display: none;">Clear All</button>
                        </div>
                        <div id="entryHistory">
                            <div class="empty-state">
                                No entries recorded yet. When you log your first entry, it will appear here.
                            </div>
                        </div>
                    </div>
                `;
                
                // Re-initialize elements after restoring interface
                this.initializeElements();
                this.bindEvents();
                this.updateButtonsForCategory();
                this.updateStats();
                this.renderHistory();
                this.updateCategoryVisibility(true); // Skip interface restore to prevent recursion
            }

            loadCategoryVisibilitySettings() {
                try {
                    const saved = localStorage.getItem('categoryVisibility');
                    if (saved) {
                        this.categoryVisibility = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Failed to load category visibility settings:', error);
                    // Use defaults
                    this.categoryVisibility = { vaping: true, alcohol: true };
                }
            }

            saveCategoryVisibilitySettings() {
                try {
                    localStorage.setItem('categoryVisibility', JSON.stringify(this.categoryVisibility));
                } catch (error) {
                    console.error('Failed to save category visibility settings:', error);
                }
            }
        }

        // Initialize the app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new QuitTracker();
            
            // Update smoke-free time every minute
            setInterval(() => {
                app.updateStats();
            }, 60000);
        });

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA install prompt available');
        });
    </script>
</body>
</html>
