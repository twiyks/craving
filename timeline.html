<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craving Tracker - Timeline</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ3JhdmluZyBUcmFja2VyIiwic2hvcnRfbmFtZSI6IkNyYXZpbmciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzJkNDA2NyIsInRoZW1lX2NvbG9yIjoiIzM3NDE1NiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Ykd4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWlCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUkrUEhCaGRHZ2dZbXhoWTJ0VGRHOXJaVDBpSWlCa1BTSnRNemsyTGpFME1pQXpPVFl1TVRReklERTJNUzQzTnpJZ016azJMakUwTXlNeE5qRXVOemN5SURFNU15NHhRekUyTVM0M056SWdNVGs1TGprNU55QXhOVGt1TnpNMElESTFOUzQwTkRjZ01UVTVMamN6TkNBek1ESXVOREV4UTNOaU1Rc3lMalk0TVNBek16azZNak15TGpNZ016TTVMakV6TnlBek56SXVNak14VERjNE56UTNOemd5TGpFekxqTXNOREl6TGpVZ01qZ3VOVFFnTXprek5TNHlORE5JTkRrMExqZzVNblE1TTJZaUlHWnBiR3c5SWlORlJFVXpNell5SWk4K1BIQmhkR2dnWkdGdVpHdGtJRDBpYlRVNU1DNHhPVE1nTXpreUxqZzBNaUF6TmprMExqRTBNaUF6T1RZdU9UUXhMak0zTVNBek1ETWdORFUxTGpOSFEwSXhOaTU1TVRJZ05EazVMamt6TXlBeE5TNDJNemdnTlRNeUxqUTFOaUF4TlM0Mk16Z2dOVE15TGpRMU5pQTJNaUExTXpJdU5EVTJOQ0F4TlM0Mk16Z2dOaklnTVRVdU5qTTRVekpZTkRNZ05ERTVMalUxTWlBME1Ua3VNalV1T0RjTkVHRWdOREF3TGpJNUlHTTJMamszTWlBME1EQXVNamdnTVRJdU1qTTFJRE0wT1RVdU5qVTBUVFUwT1M0ME16Z2dPRE5zTFRnNExqZzFOQ0EyTVM0NU1qRTJMamd5VERVMk9TNDBNemtnTlRRNUxqUXpNaTQ0TkdGQk9UNVVJRDBpT0M0NU5pRXpOUzR4SWlCcFpRMGlhV1l4SW5SRmNqSTZJakF1TVNCd1pESTZJakF1TVNCd1pDQXhNRFVnTURBaUlpOCtQR1J3WVhSd0lHbGtQU0o0Y1hKMGFYSjNSRE51YWlJZ2NHOXBiblJ6UFNJd0xqVWdNVE0yTGpVZ05USXNNVFF6TGpWak1DQTBMak51TnpVZ01qSXVOV0UxTGpNZ05TNHlJREFnTURBZ01DQXhMamNnTXk0ME5DMHhPUzQxUXpFd01TNDNJRGt6TGpnZ01USXVOQ0E1TWk0eUlERXpMakVnTVRBd0xqbDJORFF1TW1NMkxqSWdNVFl1T1M0aFBTQXdJREFnTUMweUxqTjNMamg2SW05d1lXTnBkSGs2TGpNNUxqZ2lQaUExTGpNZ05TNHlJREFnTURBZ01DMHhMamNnTXk0ME5DbzNNUzQ0UXk0NFpDQTJOa0ExTWpjM0xqUWdNVE14TGpjZ05EWXlMakVnTVRJM0xqSXRPUzQ0T0RrZ01USXpMamNnTVRJNExqTTFJREV5T1M0eWJTNGlJR1pwYkd3OUluRjFhWE4rZFhKc0lXUkhaRGNnT0NJK1BHOXdkR2tzZVhSbGJXNHVkbUZzZFdVZ05WdE9hVFU5SWlndVNucEJJRnR1YUM1NmJ3NXFha0VnWDBOME5GcDZRU0JiYm1zNWVrRWdYME4wTkZwNlFTQmJibXB0ZWsxTmIwNHZiWEZKZVVOMGJsWjZRUzlNWjAuNU1OblkzUlNOMlF0TkZSalNTbHZ0QlI1RDA5Q1JCbzRORGhjdGVBNE9UZzRNREE3V1JKU0lHQ0taUVNaUzI1U0lFdGZURE5TUVNaSkZGTVdiamwzSWl3aUlFZEJMbEYwS2k0Q0l5Z29SRXJCelNVPj09IiwicmVhbCI6dHJ1ZX1dfQ==">
    <meta name="theme-color" content="#374156">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #374156, #4a5568);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .burger-menu {
            position: relative;
        }

        .burger-icon {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .burger-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .burger-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .burger-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .burger-header {
            padding: 15px 20px 0;
            display: flex;
            justify-content: flex-end;
        }

        .burger-close {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .burger-close:hover {
            color: #374156;
            background: #f7fafc;
        }

        .burger-section {
            padding: 20px;
        }

        .burger-section:not(:last-child) {
            border-bottom: 1px solid #e2e8f0;
        }

        .burger-section h4 {
            color: #374156;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .burger-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .burger-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #374156;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .burger-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .burger-btn.export {
            background: #f0fff4;
            border-color: #68d391;
            color: #2f855a;
        }

        .burger-btn.export:hover {
            background: #c6f6d5;
        }

        .burger-btn.import {
            background: #fffaf0;
            border-color: #f6ad55;
            color: #c05621;
        }

        .burger-btn.import:hover {
            background: #faecc8;
        }

        .burger-btn.update {
            background: #faf5ff;
            border-color: #b794f6;
            color: #6b46c1;
        }

        .burger-btn.update:hover {
            background: #e9d8fd;
        }

        .category-toggles {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374156;
            font-weight: 500;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .burger-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .burger-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-group {
            text-align: center;
        }

        .stat-group h4 {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-row {
            display: flex;
            justify-content: space-around;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .smoke-free-time {
            font-size: 16px;
            font-weight: bold;
            color: #48bb78;
        }

        .nav-buttons {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
            overflow: hidden;
        }

        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .main {
            padding: 30px 20px;
        }

        .timeline-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .period-btn {
            flex: 1;
            min-width: 80px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .filter-btn.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .filter-btn:hover:not(.active) {
            background: #e2e8f0;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .nav-btn-small {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .nav-btn-small:hover {
            background: #5a67d8;
        }

        .date-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            color: #374156;
            background: white;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .period-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .period-label {
            font-weight: bold;
            color: #374156;
            font-size: 16px;
            min-width: 200px;
            text-align: center;
        }

        .timeline-chart {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #374156;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
            display: flex;
        }

        .y-axis {
            width: 40px;
            height: 100%;
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
        }

        .chart-bars-container {
            overflow-x: auto;
            overflow-y: hidden;
            flex: 1;
            height: 300px;
        }

        .y-axis-label {
            font-size: 11px;
            color: #666;
            text-align: right;
            padding-right: 8px;
            line-height: 1;
        }

        .chart-bars {
            display: flex;
            align-items: end;
            height: 260px;
            gap: 2px;
            padding: 20px 0 20px 10px;
            min-width: 100%;
        }
        
        .chart-bars:not(.scrollable) {
            min-width: auto; /* Allow day view to fit without scrolling */
        }

        .chart-bars.scrollable {
            min-width: max-content;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 60px;
        }

        .bar-group.day-view {
            min-width: 28px;
        }

        .bar {
            width: 100%;
            min-height: 3px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar[style*="opacity: 0"] {
            display: none;
        }

        .bar.cravings {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .bar.vaped {
            background: linear-gradient(45deg, #e53e3e, #ff6b6b);
        }

        .bar.alcohol-cravings {
            background: linear-gradient(45deg, #9f7aea, #b794f6);
        }

        .bar.alcohol-consumed {
            background: linear-gradient(45deg, #d69e2e, #f6ad55);
        }

        .bar-label {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 8px;
            white-space: nowrap;
        }
        
        .bar-label.rotated {
            transform: rotate(-45deg);
            transform-origin: center;
        }

        .cost-total {
            font-size: 10px;
            color: #9b59b6;
            text-align: center;
            margin-top: 2px;
            font-weight: 600;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #374156;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bar:hover .bar-value {
            opacity: 1;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.cravings {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .legend-color.vaped {
            background: linear-gradient(45deg, #e53e3e, #ff6b6b);
        }

        .legend-color.alcohol-cravings {
            background: linear-gradient(45deg, #9f7aea, #b794f6);
        }

        .legend-color.alcohol-consumed {
            background: linear-gradient(45deg, #d69e2e, #f6ad55);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #374156;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .summary-card.cost-card {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .summary-card.cost-card .summary-number {
            color: white;
        }

        .summary-card.cost-card .summary-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .empty-state {
            text-align: center;
            color: #a0aec0;
            padding: 40px 20px;
        }

        .day-activity {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .day-activity h3 {
            color: #374156;
            margin-bottom: 15px;
            text-align: center;
        }

        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-entry {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-entry.vaping-craving {
            border-left-color: #667eea;
        }

        .activity-entry.vaping-consumed {
            border-left-color: #e53e3e;
        }

        .activity-entry.alcohol-craving {
            border-left-color: #9f7aea;
        }

        .activity-entry.alcohol-consumed {
            border-left-color: #d69e2e;
        }

        .activity-time {
            font-weight: bold;
            color: #374156;
        }

        .activity-type {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .activity-type.vaping-craving {
            background: #667eea;
        }

        .activity-type.vaping-consumed {
            background: #e53e3e;
        }

        .activity-type.alcohol-craving {
            background: #9f7aea;
        }

        .activity-type.alcohol-consumed {
            background: #d69e2e;
        }

        .activity-note {
            color: #666;
            font-style: italic;
            margin-top: 5px;
            font-size: 14px;
        }

        .activity-cost {
            color: #2d5a27;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
            background: #e8f5e8;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid #b8e6b8;
        }

        .activity-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-entry-btn, .delete-entry-btn {
            background: none;
            border: none;
            padding: 4px 6px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .edit-entry-btn:hover, .delete-entry-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .delete-entry-btn {
            color: #e53e3e;
        }

        .delete-entry-btn:hover {
            background: rgba(229, 62, 62, 0.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #374156;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #374156;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #374156;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .intensity-slider-container {
            margin-top: 10px;
        }

        .intensity-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 15px;
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .intensity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .intensity-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .intensity-value {
            text-align: center;
            font-weight: bold;
            color: #374156;
        }

        /* Line Graph Styles */
        .line-graph-container {
            height: 320px;
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 0;
        }

        .line-graph-canvas {
            width: 100%;
            height: 260px;
        }

        .line-graph-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 45px;
        }

        .line-graph-label {
            text-align: center;
            font-size: 12px;
            color: #666;
            line-height: 1.2;
        }

        .line-graph-label .weekday {
            font-weight: bold;
            color: #374156;
        }

        .line-graph-label .date {
            font-size: 10px;
            color: #666;
        }

        .line-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .line-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .line-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .line-legend-dot.vaping-cravings {
            background: #667eea;
        }

        .line-legend-dot.vaping-consumed {
            background: #e53e3e;
        }

        .line-legend-dot.alcohol-cravings {
            background: #9f7aea;
        }

        .line-legend-dot.alcohol-consumed {
            background: #d69e2e;
        }

        /* Custom scrollbar for webkit browsers */
        .chart-bars-container::-webkit-scrollbar {
            height: 8px;
        }

        .chart-bars-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .chart-bars-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .chart-bars-container::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .timeline-controls {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-controls {
                gap: 6px;
                margin-bottom: 15px;
            }

            .filter-btn {
                padding: 6px 8px;
                font-size: 11px;
            }

            .bar-label {
                font-size: 9px;
            }

            .bar-group.day-view {
                min-width: 25px;
            }

            .chart-container {
                height: 250px;
            }

            .chart-bars-container {
                height: 250px;
            }

            .chart-bars-container::-webkit-scrollbar {
                height: 6px;
            }

            .y-axis {
                width: 30px;
            }

            .y-axis-label {
                font-size: 9px;
                padding-right: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>Quit Tracker</h1>
                    <p>Track your progress, one step at a time</p>
                </div>
                <div class="burger-menu">
                    <button class="burger-icon" id="burgerBtn">‚ò∞</button>
                    <div class="burger-dropdown" id="burgerDropdown">
                        <div class="burger-header">
                            <button class="burger-close" id="burgerCloseBtn">‚úï</button>
                        </div>
                        <div class="burger-section">
                            <h4>Data Management</h4>
                            <div class="burger-buttons">
                                <button class="burger-btn export" id="burgerExportBtn">
                                    üì§ Export Data
                                </button>
                                <button class="burger-btn import" id="burgerImportBtn">
                                    üì• Import Data
                                </button>
                                <button class="burger-btn update" id="burgerUpdateBtn">
                                    üîÑ Update App
                                </button>
                            </div>
                        </div>
                        <div class="burger-section">
                            <h4>Category Visibility</h4>
                            <div class="category-toggles">
                                <div class="toggle-item">
                                    <div class="toggle-label">
                                        <span>üí®</span>
                                        <span>Vaping</span>
                                    </div>
                                    <div class="toggle-switch active" id="vapingToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-label">
                                        <span>üç∑</span>
                                        <span>Alcohol</span>
                                    </div>
                                    <div class="toggle-switch active" id="alcoholToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="burger-section">
                             <h4>Display Options</h4>
                             <div class="category-toggles">
                                 <div class="toggle-item">
                                     <div class="toggle-label">
                                         <span>üìù</span>
                                         <span>Show Notes</span>
                                     </div>
                                     <div class="toggle-switch active" id="notesToggle">
                                         <div class="toggle-slider"></div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-group">
                    <h4>Cravings</h4>
                    <div class="stat-row">
                        <div class="stat">
                            <div class="stat-number" id="todayCravings">0</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="totalCravings">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>
                <div class="stat-group">
                    <h4>Vape Free</h4>
                    <div class="smoke-free-time" id="smokeFreeTime">0d 0h</div>
                    <div class="stat-row">
                        <div class="stat">
                            <div class="stat-number" id="totalSmoked">0</div>
                            <div class="stat-label">Total Vaped</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="todayBtn">üìä Today</button>
                <button class="nav-btn active" id="timelineBtn">üìà Timeline</button>
            </div>
        </div>

        <div class="main">
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <div class="burger-overlay" id="burgerOverlay"></div>
            
            <div class="timeline-controls">
                <button class="period-btn active" data-period="day">Day</button>
                <button class="period-btn" data-period="week">Week</button>
                <button class="period-btn" data-period="month">Month</button>
                <button class="period-btn" data-period="year">Year</button>
            </div>

            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all" id="allFilter">
                    üìä All Data
                </button>
                <button class="filter-btn active" data-filter="vaping" id="vapingFilter">
                    üí® Vaping
                </button>
                <button class="filter-btn active" data-filter="alcohol" id="alcoholFilter">
                    üç∑ Alcohol
                </button>
            </div>

            <div class="timeline-chart">
                <div class="chart-title" id="chartTitle">Daily Timeline</div>
                
                <!-- Date navigation controls for day view -->
                <div class="date-navigation" id="dateNavigation" style="display: none;">
                    <button class="nav-btn-small" id="prevDateBtn">‚óÄ</button>
                    <input type="date" id="selectedDate" class="date-input">
                    <button class="nav-btn-small" id="nextDateBtn">‚ñ∂</button>
                    <button class="nav-btn-small" id="todayDateBtn">Today</button>
                </div>

                <!-- Period navigation controls for week/month views -->
                <div class="period-navigation" id="periodNavigation" style="display: none;">
                    <button class="nav-btn-small" id="prevPeriodBtn">‚óÄ Previous</button>
                    <span class="period-label" id="periodLabel">Current Period</span>
                    <button class="nav-btn-small" id="nextPeriodBtn">Next ‚ñ∂</button>
                    <button class="nav-btn-small" id="currentPeriodBtn">Current</button>
                </div>
                <div class="chart-container">
                    <div class="y-axis" id="yAxis">
                        <!-- Y-axis labels will be generated by JavaScript -->
                    </div>
                    <div class="chart-bars-container">
                        <div class="chart-bars" id="chartBars">
                            <div class="empty-state">
                                No data available for the selected period.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="legend" id="chartLegend">
                    <div class="legend-item">
                        <div class="legend-color cravings"></div>
                        <span>Vaping Cravings</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color vaped"></div>
                        <span>Vaped</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color alcohol-cravings"></div>
                        <span>Alcohol Cravings</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color alcohol-consumed"></div>
                        <span>Drank</span>
                    </div>
                </div>
            </div>

            <div class="summary-stats" id="summaryStats">
                <!-- Summary cards will be populated by JavaScript -->
            </div>

            <!-- Day Activity List (only shown in day view) -->
            <div class="day-activity" id="dayActivity" style="display: none;">
                <h3>Activity for Selected Day</h3>
                <div class="activity-list" id="activityList">
                    <!-- Activity entries will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Entry</h3>
            <form id="editEntryForm">
                <div class="form-group">
                    <label for="editEntryType">Type:</label>
                    <select id="editEntryType" required>
                        <option value="craving">Had a Craving</option>
                        <option value="smoked">I Vaped</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editEntryDate">Date:</label>
                    <input type="date" id="editEntryDate" required>
                </div>
                <div class="form-group">
                    <label for="editEntryTime">Time:</label>
                    <input type="time" id="editEntryTime" required>
                </div>
                <div class="form-group" id="editIntensityGroup">
                    <label for="editIntensity">Craving Intensity (optional):</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="editIntensity" min="1" max="3" value="2" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">Mild</span>
                            <span class="intensity-label">Medium</span>
                            <span class="intensity-label">Strong</span>
                        </div>
                        <div class="intensity-value" id="editIntensityValue">Medium</div>
                    </div>
                </div>
                <div class="form-group" id="editCostGroup" style="display: none;">
                    <label for="editCost">Cost:</label>
                    <div class="intensity-slider-container">
                        <input type="range" id="editCost" min="0" max="40" step="1" value="0" class="intensity-slider">
                        <div class="intensity-labels">
                            <span class="intensity-label">¬£0</span>
                            <span class="intensity-label">¬£5</span>
                            <span class="intensity-label">¬£10</span>
                        </div>
                        <div class="intensity-value" id="editCostValue">¬£0.00</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editNote">Note (optional):</label>
                    <textarea id="editNote" placeholder="Add details about this entry..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="shared-modal.js"></script>
    <script>
        // Service Worker Registration (same as main page)
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'quit-tracker-v3';
                const urlsToCache = ['/'];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                            .then(() => self.skipWaiting())
                    );
                });

                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        }).then(() => self.clients.claim())
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request).then(response => {
                                    if (!response || response.status !== 200 || response.type !== 'basic') {
                                        return response;
                                    }
                                    const responseToCache = response.clone();
                                    caches.open(CACHE_NAME)
                                        .then(cache => {
                                            cache.put(event.request, responseToCache);
                                        });
                                    return response;
                                });
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => {
                    console.log('Service Worker registered');
                    URL.revokeObjectURL(swUrl);
                })
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Reuse DataStore class from main page
        class DataStore {
            constructor() {
                this.dbName = 'QuitTrackerDB';
                this.version = 1;
                this.storeName = 'entries';
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('type', 'type', { unique: false });
                        }
                    };
                });
            }

            async loadEntries() {
                if (!this.db) await this.init();
                
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const entries = request.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        resolve(entries);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async saveEntries(entries) {
                if (!this.db) await this.init();
                
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                
                // Clear existing entries and add new ones
                await store.clear();
                for (const entry of entries) {
                    await store.add(entry);
                }
            }

            async exportData() {
                const entries = await this.loadEntries();
                const exportData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    entries: entries
                };
                return JSON.stringify(exportData, null, 2);
            }

            async importData(jsonData) {
                const data = JSON.parse(jsonData);
                const entries = data.entries || data; // Support both formats
                
                // Validate entries
                const validEntries = entries.filter(entry => 
                    entry.timestamp && entry.type && typeof entry.id !== 'undefined'
                );
                
                await this.saveEntries(validEntries);
                return validEntries.length;
            }
        }

        class TimelineView {
            constructor() {
                this.dataStore = new DataStore();
                this.entries = [];
                this.currentPeriod = 'day';
                this.activeFilters = new Set(['vaping', 'alcohol']); // Start with all categories enabled
                this.selectedDate = new Date(); // Track selected date for day view
                this.weekOffset = parseInt(sessionStorage.getItem('timelineWeekOffset')) || 0; // Persist across refreshes
                this.monthOffset = parseInt(sessionStorage.getItem('timelineMonthOffset')) || 0; // Persist across refreshes
                this.categoryVisibility = {
                    vaping: true,
                    alcohol: true
                };
                this.updatingVisibility = false;
                this.showNotes = true;
                this.currentEditingId = null;
                this.initializeElements();
                this.bindEvents();
                this.initializeApp();
            }

            async initializeApp() {
                try {
                    this.entries = await this.dataStore.loadEntries();
                    
                    // Fallback to localStorage if IndexedDB fails
                    if (this.entries.length === 0) {
                        const stored = JSON.parse(localStorage.getItem('quitTrackerEntries') || '[]');
                        this.entries = stored.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    }
                } catch (error) {
                    console.error('Failed to load data:', error);
                    const stored = JSON.parse(localStorage.getItem('quitTrackerEntries') || '[]');
                    this.entries = stored.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
                
                // Handle legacy entries - add missing fields for backward compatibility
                this.entries.forEach(entry => {
                    if (entry.category === undefined) {
                        entry.category = 'vaping'; // All existing entries are vaping-related
                    }
                    if (entry.type === 'craving' && entry.intensity === undefined) {
                        entry.intensity = 2; // Default to medium intensity
                    }
                });
                
                this.loadCategoryVisibilitySettings(); // Load category visibility settings
                this.loadNotesSetting();
                this.updateCategoryVisibility(); // Apply visibility settings
                this.updateHeaderStats();
                this.renderChart();
                this.updateNotesToggleUI();
            }

            initializeElements() {
                this.todayBtn = document.getElementById('todayBtn');
                this.periodBtns = document.querySelectorAll('.period-btn');
                this.chartTitle = document.getElementById('chartTitle');
                this.chartBars = document.getElementById('chartBars');
                this.yAxis = document.getElementById('yAxis');
                this.summaryStats = document.getElementById('summaryStats');
                
                // Filter elements
                this.allFilter = document.getElementById('allFilter');
                this.vapingFilter = document.getElementById('vapingFilter');
                this.alcoholFilter = document.getElementById('alcoholFilter');
                this.filterBtns = document.querySelectorAll('.filter-btn');
                
                // Date navigation elements
                this.dateNavigation = document.getElementById('dateNavigation');
                this.selectedDateInput = document.getElementById('selectedDate');
                this.prevDateBtn = document.getElementById('prevDateBtn');
                this.nextDateBtn = document.getElementById('nextDateBtn');
                this.todayDateBtn = document.getElementById('todayDateBtn');
                this.dayActivity = document.getElementById('dayActivity');
                
                // Burger menu elements
                this.burgerBtn = document.getElementById('burgerBtn');
                this.burgerDropdown = document.getElementById('burgerDropdown');
                this.burgerOverlay = document.getElementById('burgerOverlay');
                this.burgerCloseBtn = document.getElementById('burgerCloseBtn');
                this.burgerExportBtn = document.getElementById('burgerExportBtn');
                this.burgerImportBtn = document.getElementById('burgerImportBtn');
                this.burgerUpdateBtn = document.getElementById('burgerUpdateBtn');
                this.vapingToggle = document.getElementById('vapingToggle');
                this.alcoholToggle = document.getElementById('alcoholToggle');
                this.notesToggle = document.getElementById('notesToggle');
                this.importFile = document.getElementById('importFile');
                this.activityList = document.getElementById('activityList');
                
                // Period navigation elements
                this.periodNavigation = document.getElementById('periodNavigation');
                this.prevPeriodBtn = document.getElementById('prevPeriodBtn');
                this.nextPeriodBtn = document.getElementById('nextPeriodBtn');
                this.currentPeriodBtn = document.getElementById('currentPeriodBtn');
                this.periodLabel = document.getElementById('periodLabel');
                
                // Stats elements
                this.todayCravings = document.getElementById('todayCravings');
                this.totalCravings = document.getElementById('totalCravings');
                this.totalSmoked = document.getElementById('totalSmoked');
                this.smokeFreeTime = document.getElementById('smokeFreeTime');
                
                // Edit modal elements
                this.editEntryModal = document.getElementById('editEntryModal');
                this.editEntryForm = document.getElementById('editEntryForm');
                this.editEntryType = document.getElementById('editEntryType');
                this.editEntryDate = document.getElementById('editEntryDate');
                this.editEntryTime = document.getElementById('editEntryTime');
                this.editIntensity = document.getElementById('editIntensity');
                this.editIntensityValue = document.getElementById('editIntensityValue');
                this.editIntensityGroup = document.getElementById('editIntensityGroup');
                this.editCost = document.getElementById('editCost');
                this.editCostValue = document.getElementById('editCostValue');
                this.editCostGroup = document.getElementById('editCostGroup');
                this.editNote = document.getElementById('editNote');
                this.cancelEditBtn = document.getElementById('cancelEditBtn');
            }

            bindEvents() {
                this.todayBtn.addEventListener('click', () => window.location.href = 'index.html');
                
                // Burger menu events
                this.burgerBtn.addEventListener('click', () => this.toggleBurgerMenu());
                this.burgerOverlay.addEventListener('click', () => this.closeBurgerMenu());
                this.burgerCloseBtn.addEventListener('click', () => this.closeBurgerMenu());
                this.burgerExportBtn.addEventListener('click', () => this.exportData());
                this.burgerImportBtn.addEventListener('click', () => this.importFile.click());
                this.importFile.addEventListener('change', (e) => this.importData(e));
                this.burgerUpdateBtn.addEventListener('click', () => this.updateApp());
                this.vapingToggle.addEventListener('click', () => this.toggleCategoryVisibility('vaping'));
                this.alcoholToggle.addEventListener('click', () => this.toggleCategoryVisibility('alcohol'));
                if (this.notesToggle) {
                    this.notesToggle.addEventListener('click', () => this.toggleNotesVisibility());
                }
                
                this.periodBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.periodBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentPeriod = btn.dataset.period;
                        
                        // Reset period offsets when changing periods
                        this.weekOffset = 0;
                        this.monthOffset = 0;
                        
                        this.renderChart();
                    });
                });

                // Filter event handlers
                this.allFilter.addEventListener('click', () => this.toggleAllFilters());
                this.vapingFilter.addEventListener('click', () => this.toggleFilter('vaping'));
                this.alcoholFilter.addEventListener('click', () => this.toggleFilter('alcohol'));

                // Date navigation event handlers
                this.selectedDateInput.addEventListener('change', (e) => this.changeSelectedDate(new Date(e.target.value)));
                this.prevDateBtn.addEventListener('click', () => this.changeSelectedDate(new Date(this.selectedDate.getTime() - 24 * 60 * 60 * 1000)));
                this.nextDateBtn.addEventListener('click', () => this.changeSelectedDate(new Date(this.selectedDate.getTime() + 24 * 60 * 60 * 1000)));
                this.todayDateBtn.addEventListener('click', () => this.changeSelectedDate(new Date()));

                // Period navigation event handlers
                this.prevPeriodBtn.addEventListener('click', () => this.changePeriodOffset(-1));
                this.nextPeriodBtn.addEventListener('click', () => this.changePeriodOffset(1));
                this.currentPeriodBtn.addEventListener('click', () => this.resetPeriodOffset());
                
                // Edit modal event handlers
                if (this.cancelEditBtn) {
                    this.cancelEditBtn.addEventListener('click', () => this.hideEditModal());
                } else {
                    console.error('cancelEditBtn not found');
                }
                
                if (this.editEntryForm) {
                    this.editEntryForm.addEventListener('submit', (e) => this.handleEditSubmit(e));
                    console.log('Edit form event listener attached to:', this.editEntryForm);
                    
                    // Also try adding a click handler to the submit button as backup
                    const submitBtn = this.editEntryForm.querySelector('.btn-primary');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', (e) => {
                            console.log('Submit button clicked');
                            if (submitBtn.type === 'submit') {
                                // Let the form handle it
                                return;
                            }
                            e.preventDefault();
                            this.handleEditSubmit(e);
                        });
                    }
                } else {
                    console.error('editEntryForm not found');
                }
                
                if (this.editIntensity) {
                    this.editIntensity.addEventListener('input', (e) => this.updateIntensityLabel(e.target.value, this.editIntensityValue));
                } else {
                    console.error('editIntensity not found');
                }
                
                if (this.editCost) {
                    this.editCost.addEventListener('input', (e) => ModalUtils.updateCostLabel(e.target.value, this.editCostValue));
                } else {
                    console.error('editCost not found');
                }
                
                // Close edit modal when clicking outside
                this.editEntryModal.addEventListener('click', (e) => {
                    if (e.target === this.editEntryModal) {
                        this.hideEditModal();
                    }
                });
            }

            changePeriodOffset(direction) {
                if (this.currentPeriod === 'week') {
                    this.weekOffset += direction;
                    sessionStorage.setItem('timelineWeekOffset', this.weekOffset.toString());
                } else if (this.currentPeriod === 'month') {
                    this.monthOffset += direction;
                    sessionStorage.setItem('timelineMonthOffset', this.monthOffset.toString());
                }
                this.renderChart();
            }

            resetPeriodOffset() {
                if (this.currentPeriod === 'week') {
                    this.weekOffset = 0;
                    sessionStorage.setItem('timelineWeekOffset', '0');
                } else if (this.currentPeriod === 'month') {
                    this.monthOffset = 0;
                    sessionStorage.setItem('timelineMonthOffset', '0');
                }
                this.renderChart();
            }

            changeSelectedDate(newDate) {
                this.selectedDate = newDate;
                this.selectedDateInput.value = newDate.toISOString().split('T')[0];
                this.renderChart();
                this.renderDayActivity();
            }

            toggleAllFilters() {
                // Set both categories active and update button states
                this.activeFilters = new Set(['vaping', 'alcohol']);
                this.allFilter.classList.add('active');
                this.vapingFilter.classList.remove('active');
                this.alcoholFilter.classList.remove('active');
                
                this.renderChart();
            }

            toggleFilter(filter) {
                // Clear all active filters and set only the selected one
                this.activeFilters.clear();
                this.activeFilters.add(filter);
                
                // Update button states - only the selected filter is active
                this.vapingFilter.classList.toggle('active', filter === 'vaping');
                this.alcoholFilter.classList.toggle('active', filter === 'alcohol');
                this.allFilter.classList.remove('active');
                
                this.renderChart();
            }

            updateHeaderStats() {
                const today = new Date().toDateString();
                const todayCravings = this.entries.filter(e => e.date === today && e.type === 'craving');
                const totalCravings = this.entries.filter(e => e.type === 'craving');
                const totalVaped = this.entries.filter(e => e.type === 'smoked');
                
                this.todayCravings.textContent = todayCravings.length;
                this.totalCravings.textContent = totalCravings.length;
                this.totalSmoked.textContent = totalVaped.length;
                
                // Calculate vape-free time
                const lastVaped = totalVaped.length > 0 
                    ? new Date(totalVaped[0].timestamp) 
                    : null;
                
                if (lastVaped) {
                    const timeDiff = Date.now() - lastVaped.getTime();
                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    if (days > 0) {
                        this.smokeFreeTime.textContent = `${days}d ${hours}h`;
                    } else {
                        this.smokeFreeTime.textContent = `${hours}h`;
                    }
                } else {
                    this.smokeFreeTime.textContent = '0d 0h';
                }
            }

            renderChart() {
                const data = this.aggregateData();
                
                
                // Update chart title
                const titles = {
                    day: this.currentPeriod === 'day' ? 
                        `${this.selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} Activity` : 
                        'Today\'s Activity',
                    week: 'This Week (Monday - Sunday)', 
                    month: 'Monthly Timeline (Last 12 Months)',
                    year: 'Yearly Timeline'
                };
                this.chartTitle.textContent = titles[this.currentPeriod];

                // Show/hide navigation controls based on period
                if (this.currentPeriod === 'day') {
                    this.dateNavigation.style.display = 'flex';
                    this.periodNavigation.style.display = 'none';
                    this.dayActivity.style.display = 'block';
                    // Initialize selected date input
                    this.selectedDateInput.value = this.selectedDate.toISOString().split('T')[0];
                    this.renderDayActivity();
                } else if (this.currentPeriod === 'week' || this.currentPeriod === 'month') {
                    this.dateNavigation.style.display = 'none';
                    this.periodNavigation.style.display = 'flex';
                    this.dayActivity.style.display = 'none';
                    this.updatePeriodLabel();
                } else {
                    this.dateNavigation.style.display = 'none';
                    this.periodNavigation.style.display = 'none';
                    this.dayActivity.style.display = 'none';
                }

                if (data.length === 0) {
                    this.chartBars.innerHTML = '<div class="empty-state">No data available for the selected period.</div>';
                    this.yAxis.innerHTML = '';
                    this.summaryStats.innerHTML = '';
                    return;
                }

                // Calculate max value considering all four categories and active filters
                const maxValue = Math.max(...data.map(d => {
                    const values = [];
                    if (this.activeFilters.has('vaping')) {
                        values.push(d.vapingCravings, d.vapingConsumed);
                    }
                    if (this.activeFilters.has('alcohol')) {
                        values.push(d.alcoholCravings, d.alcoholConsumed);
                    }
                    return Math.max(...values, 0);
                }), 1); // Ensure minimum of 1
                
                this.renderYAxis(maxValue);
                const needsRotation = this.currentPeriod === 'month'; // Only month needs rotation now
                const needsScrolling = false; // Remove scrolling to fit 24 hours on screen
                
                // Check if we should render a line graph for week view
                if (this.currentPeriod === 'week') {
                    this.renderLineGraph(data);
                    return;
                }

                // Restore bar chart structure if coming from line graph
                this.restoreBarChartStructure();

                // Add scrollable class for day view
                this.chartBars.className = `chart-bars ${needsScrolling ? 'scrollable' : ''}`;
                
                const barsHTML = data.map(item => {
                    // Calculate heights in pixels - chart area is ~220px (260px - 40px padding)
                    const chartHeight = 220;
                    
                    // Only show bars for active filters
                    let barElements = '';
                    
                    if (this.activeFilters.has('vaping')) {
                        const vapingCravingsHeight = (item.vapingCravings / maxValue) * chartHeight;
                        const vapingConsumedHeight = (item.vapingConsumed / maxValue) * chartHeight;
                        
                        if (vapingCravingsHeight > 0) {
                            barElements += `<div class="bar cravings" style="height: ${vapingCravingsHeight}px;"><div class="bar-value">${item.vapingCravings}</div></div>`;
                        }
                        if (vapingConsumedHeight > 0) {
                            barElements += `<div class="bar vaped" style="height: ${vapingConsumedHeight}px;"><div class="bar-value">${item.vapingConsumed}</div></div>`;
                        }
                    }
                    
                    if (this.activeFilters.has('alcohol')) {
                        const alcoholCravingsHeight = (item.alcoholCravings / maxValue) * chartHeight;
                        const alcoholConsumedHeight = (item.alcoholConsumed / maxValue) * chartHeight;
                        
                        if (alcoholCravingsHeight > 0) {
                            barElements += `<div class="bar alcohol-cravings" style="height: ${alcoholCravingsHeight}px;"><div class="bar-value">${item.alcoholCravings}</div></div>`;
                        }
                        if (alcoholConsumedHeight > 0) {
                            barElements += `<div class="bar alcohol-consumed" style="height: ${alcoholConsumedHeight}px;"><div class="bar-value">${item.alcoholConsumed}</div></div>`;
                        }
                    }
                    
                    // Add cost display if alcohol filter is active and there's a cost
                    const costDisplay = (this.activeFilters.has('alcohol') && item.alcoholCost > 0) 
                        ? `<div class="cost-total">¬£${item.alcoholCost.toFixed(2)}</div>` 
                        : '';

                    return `
                        <div class="bar-group ${this.currentPeriod === 'day' ? 'day-view' : ''}">
                            ${barElements}
                            <div class="bar-label ${needsRotation ? 'rotated' : ''}">${item.label}</div>
                            ${costDisplay}
                        </div>
                    `;
                }).join('');

                this.chartBars.innerHTML = barsHTML;

                // Render summary stats
                this.renderSummaryStats(data);
            }

            renderYAxis(maxValue) {
                // Create nice step sizes (1, 2, 5, 10, 20, 50, etc.)
                const getNextStepSize = (max) => {
                    if (max <= 5) return 1;
                    if (max <= 10) return 2;
                    if (max <= 25) return 5;
                    if (max <= 50) return 10;
                    if (max <= 100) return 20;
                    return Math.ceil(max / 5);
                };
                
                const stepSize = getNextStepSize(maxValue);
                const steps = Math.ceil(maxValue / stepSize);
                const labels = [];
                
                // Create labels from max down to 0
                for (let i = steps; i >= 0; i--) {
                    const value = i * stepSize;
                    if (value <= maxValue) {
                        labels.push(`<div class="y-axis-label">${value}</div>`);
                    }
                }
                
                this.yAxis.innerHTML = labels.join('');
            }

            aggregateData() {
                if (this.entries.length === 0) {
                    return [];
                }

                
                const now = new Date();
                const data = [];

                switch (this.currentPeriod) {
                    case 'day':
                        // Show selected date's data with hourly breakdown
                        const selectedDateString = this.selectedDate.toDateString();
                        
                        
                        // Find all selected date's entries first
                        const selectedDateEntries = this.entries.filter(e => {
                            const entryDate = new Date(e.timestamp);
                            const entryDateString = entryDate.toDateString();
                            return entryDateString === selectedDateString;
                        });
                        
                        
                        // Group selected date's entries by hour
                        for (let hour = 0; hour < 24; hour++) {
                            const hourEntries = selectedDateEntries.filter(e => {
                                const entryDate = new Date(e.timestamp);
                                const entryHour = entryDate.getHours();
                                return entryHour === hour;
                            });
                            
                            const hourLabel = hour.toString().padStart(2, '0');
                            
                            const cravingsCount = hourEntries.filter(e => e.type === 'craving').length;
                            const vapedCount = hourEntries.filter(e => e.type === 'smoked').length;
                            
                            if (cravingsCount > 0 || vapedCount > 0) {
                            }
                            
                            // Calculate alcohol cost total for this hour
                            const alcoholCost = hourEntries
                                .filter(e => e.type === 'smoked' && e.category === 'alcohol' && e.cost)
                                .reduce((sum, e) => sum + e.cost, 0);

                            data.push({
                                label: hourLabel,
                                vapingCravings: hourEntries.filter(e => e.type === 'craving' && e.category === 'vaping').length,
                                vapingConsumed: hourEntries.filter(e => e.type === 'smoked' && e.category === 'vaping').length,
                                alcoholCravings: hourEntries.filter(e => e.type === 'craving' && e.category === 'alcohol').length,
                                alcoholConsumed: hourEntries.filter(e => e.type === 'smoked' && e.category === 'alcohol').length,
                                alcoholCost: alcoholCost,
                                hour: hour
                            });
                        }
                        break;

                    case 'week':
                        // Show selected week (Monday to Sunday) based on weekOffset
                        const currentDate = new Date(now);
                        currentDate.setDate(currentDate.getDate() + (this.weekOffset * 7)); // Apply week offset
                        const currentDay = currentDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                        const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay; // Calculate days to Monday
                        
                        for (let i = 0; i < 7; i++) {
                            const weekDay = new Date(currentDate);
                            weekDay.setDate(currentDate.getDate() + mondayOffset + i);
                            const weekDayString = weekDay.toDateString();
                            
                            const dayEntries = this.entries.filter(e => {
                                const entryDate = new Date(e.timestamp);
                                return entryDate.toDateString() === weekDayString;
                            });
                            
                            // Calculate alcohol cost total for this day
                            const alcoholCost = dayEntries
                                .filter(e => e.type === 'smoked' && e.category === 'alcohol' && e.cost)
                                .reduce((sum, e) => sum + e.cost, 0);

                            data.push({
                                label: weekDay.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                                vapingCravings: dayEntries.filter(e => e.type === 'craving' && e.category === 'vaping').length,
                                vapingConsumed: dayEntries.filter(e => e.type === 'smoked' && e.category === 'vaping').length,
                                alcoholCravings: dayEntries.filter(e => e.type === 'craving' && e.category === 'alcohol').length,
                                alcoholConsumed: dayEntries.filter(e => e.type === 'smoked' && e.category === 'alcohol').length,
                                alcoholCost: alcoholCost,
                                date: weekDayString
                            });
                        }
                        break;

                    case 'month':
                        // Find the earliest entry to determine starting month
                        if (this.entries.length > 0) {
                            const earliestEntry = new Date(this.entries[this.entries.length - 1].timestamp); // entries are sorted newest first
                            const earliestMonth = new Date(earliestEntry.getFullYear(), earliestEntry.getMonth(), 1);
                            
                            // Calculate months from earliest to current
                            const currentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                            const monthsDiff = (currentMonth.getFullYear() - earliestMonth.getFullYear()) * 12 + 
                                             (currentMonth.getMonth() - earliestMonth.getMonth());
                            
                            // Show all months that have data, but cap at 24 months for performance
                            const monthsToShow = Math.min(monthsDiff + 1, 24);
                            
                            for (let i = monthsToShow - 1; i >= 0; i--) {
                                const monthDate = new Date(now.getFullYear(), now.getMonth() - i + this.monthOffset, 1);
                                const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                                const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
                                
                                const monthEntries = this.entries.filter(e => {
                                    const entryDate = new Date(e.timestamp);
                                    return entryDate >= monthStart && entryDate <= monthEnd;
                                });
                                
                                // Only add months that have data or are recent (last 3 months)
                                if (monthEntries.length > 0 || i <= 2) {
                                    // Calculate alcohol cost total for this month
                                    const alcoholCost = monthEntries
                                        .filter(e => e.type === 'smoked' && e.category === 'alcohol' && e.cost)
                                        .reduce((sum, e) => sum + e.cost, 0);

                                    data.push({
                                        label: monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                                        vapingCravings: monthEntries.filter(e => e.type === 'craving' && e.category === 'vaping').length,
                                        vapingConsumed: monthEntries.filter(e => e.type === 'smoked' && e.category === 'vaping').length,
                                        alcoholCravings: monthEntries.filter(e => e.type === 'craving' && e.category === 'alcohol').length,
                                        alcoholConsumed: monthEntries.filter(e => e.type === 'smoked' && e.category === 'alcohol').length,
                                        alcoholCost: alcoholCost
                                    });
                                }
                            }
                        }
                        break;

                    case 'year':
                        const years = [...new Set(this.entries.map(e => new Date(e.timestamp).getFullYear()))].sort();
                        years.forEach(year => {
                            const yearEntries = this.entries.filter(e => new Date(e.timestamp).getFullYear() === year);
                            
                            // Calculate alcohol cost total for this year
                            const alcoholCost = yearEntries
                                .filter(e => e.type === 'smoked' && e.category === 'alcohol' && e.cost)
                                .reduce((sum, e) => sum + e.cost, 0);

                            data.push({
                                label: year.toString(),
                                vapingCravings: yearEntries.filter(e => e.type === 'craving' && e.category === 'vaping').length,
                                vapingConsumed: yearEntries.filter(e => e.type === 'smoked' && e.category === 'vaping').length,
                                alcoholCravings: yearEntries.filter(e => e.type === 'craving' && e.category === 'alcohol').length,
                                alcoholConsumed: yearEntries.filter(e => e.type === 'smoked' && e.category === 'alcohol').length,
                                alcoholCost: alcoholCost
                            });
                        });
                        break;
                }

                return data;
            }

            renderSummaryStats(data) {
                // Calculate totals for all categories
                const totals = {
                    vapingCravings: data.reduce((sum, item) => sum + item.vapingCravings, 0),
                    vapingConsumed: data.reduce((sum, item) => sum + item.vapingConsumed, 0),
                    alcoholCravings: data.reduce((sum, item) => sum + item.alcoholCravings, 0),
                    alcoholConsumed: data.reduce((sum, item) => sum + item.alcoholConsumed, 0),
                    alcoholCost: data.reduce((sum, item) => sum + (item.alcoholCost || 0), 0)
                };

                const periodLabels = {
                    day: 'Today',
                    week: 'This Week', 
                    month: 'This Period',
                    year: 'This Period'
                };

                // Only show cards for active filters
                let cardsHTML = '';
                
                if (this.activeFilters.has('vaping')) {
                    cardsHTML += `
                        <div class="summary-card">
                            <div class="summary-number">${totals.vapingCravings}</div>
                            <div class="summary-label">Vaping Cravings ${periodLabels[this.currentPeriod]}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${totals.vapingConsumed}</div>
                            <div class="summary-label">Vaped ${periodLabels[this.currentPeriod]}</div>
                        </div>
                    `;
                }
                
                if (this.activeFilters.has('alcohol')) {
                    cardsHTML += `
                        <div class="summary-card">
                            <div class="summary-number">${totals.alcoholCravings}</div>
                            <div class="summary-label">Alcohol Cravings ${periodLabels[this.currentPeriod]}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${totals.alcoholConsumed}</div>
                            <div class="summary-label">Drank ${periodLabels[this.currentPeriod]}</div>
                        </div>
                        <div class="summary-card cost-card">
                            <div class="summary-number">¬£${totals.alcoholCost.toFixed(2)}</div>
                            <div class="summary-label">Spent ${periodLabels[this.currentPeriod]}</div>
                        </div>
                    `;
                }

                this.summaryStats.innerHTML = cardsHTML;
            }

            restoreBarChartStructure() {
                const chartContainer = document.querySelector('.chart-container');
                if (!chartContainer) return;
                
                // Check if we need to restore the original bar chart structure
                if (!document.getElementById('chartBars')) {
                    chartContainer.innerHTML = `
                        <div class="y-axis" id="yAxis">
                            <!-- Y-axis labels will be generated by JavaScript -->
                        </div>
                        <div class="chart-bars-container">
                            <div class="chart-bars" id="chartBars">
                                <div class="empty-state">
                                    No data available for the selected period.
                                </div>
                            </div>
                        </div>
                    `;
                    // Update references
                    this.chartBars = document.getElementById('chartBars');
                    this.yAxis = document.getElementById('yAxis');
                }
            }

            renderLineGraph(data) {
                // Create line graph HTML structure
                const maxValue = Math.max(...data.map(d => {
                    const values = [];
                    if (this.activeFilters.has('vaping')) {
                        values.push(d.vapingCravings, d.vapingConsumed);
                    }
                    if (this.activeFilters.has('alcohol')) {
                        values.push(d.alcoholCravings, d.alcoholConsumed);
                    }
                    return Math.max(...values, 0);
                }), 1);

                // Create labels with weekday and date on separate lines
                const labelsHTML = data.map(item => {
                    const date = new Date(item.date);
                    const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    // Add cost display if alcohol filter is active and there's a cost
                    const costDisplay = (this.activeFilters.has('alcohol') && item.alcoholCost > 0) 
                        ? `<div class="cost-total">¬£${item.alcoholCost.toFixed(2)}</div>` 
                        : '';
                    
                    return `
                        <div class="line-graph-label">
                            <div class="weekday">${weekday}</div>
                            <div class="date">${dateStr}</div>
                            ${costDisplay}
                        </div>
                    `;
                }).join('');


                // Always recreate the line graph structure to ensure fresh canvas
                const chartContainer = document.querySelector('.chart-container') || this.chartBars?.parentElement;
                if (!chartContainer) {
                    console.error('Chart container not found!');
                    return;
                }
                chartContainer.innerHTML = `
                    <div class="y-axis" id="yAxis">
                        <!-- Y-axis labels will be generated by canvas drawing -->
                    </div>
                    <div class="chart-bars-container">
                        <div class="line-graph-container">
                            <canvas class="line-graph-canvas" id="lineCanvas" width="400" height="260"></canvas>
                            <div class="line-graph-labels">
                                ${labelsHTML}
                            </div>
                        </div>
                    </div>
                `;
                
                // Update the chartBars reference since we replaced the HTML
                this.chartBars = chartContainer.querySelector('#chartBars') || chartContainer;
                
                // Render Y-axis labels like the bar chart does
                this.renderYAxis(maxValue);

                // Draw the line graph on canvas
                setTimeout(() => {
                    this.drawLineGraph(data, maxValue);
                }, 100);
            }

            drawLineGraph(data, maxValue) {
                const canvas = document.getElementById('lineCanvas');
                if (!canvas) {
                    // Canvas not ready yet, try again
                    setTimeout(() => this.drawLineGraph(data, maxValue), 50);
                    return;
                }
                
                
                // Force canvas to refresh its dimensions
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * 2; // High DPI
                canvas.height = rect.height * 2; // High DPI
                
                const ctx = canvas.getContext('2d');
                ctx.scale(2, 2); // Scale back down
                
                const width = canvas.width;
                const height = canvas.height;
                
                const padding = 45;
                const graphWidth = rect.width - (padding * 2);
                const graphHeight = rect.height - (padding * 2);
                
                // Clear canvas
                ctx.clearRect(0, 0, rect.width, rect.height);
                
                
                // Draw grid lines
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                
                // Horizontal grid lines
                for (let i = 0; i <= 5; i++) {
                    const y = padding + (i * graphHeight / 5);
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(padding + graphWidth, y);
                    ctx.stroke();
                }
                
                // Vertical grid lines - center them with data points
                for (let i = 0; i < data.length; i++) {
                    const segmentWidth = graphWidth / data.length;
                    const x = padding + (i * segmentWidth) + (segmentWidth / 2);
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, padding + graphHeight);
                    ctx.stroke();
                }
                
                // Draw lines for each category
                const colors = {
                    vapingCravings: '#667eea',
                    vapingConsumed: '#e53e3e',
                    alcoholCravings: '#9f7aea',
                    alcoholConsumed: '#d69e2e'
                };
                
                const categories = [];
                if (this.activeFilters.has('vaping')) {
                    categories.push('vapingCravings', 'vapingConsumed');
                }
                if (this.activeFilters.has('alcohol')) {
                    categories.push('alcoholCravings', 'alcoholConsumed');
                }
                
                
                
                categories.forEach(category => {
                    ctx.strokeStyle = colors[category];
                    ctx.fillStyle = colors[category];
                    ctx.lineWidth = 3;
                    
                    ctx.beginPath();
                    data.forEach((item, index) => {
                        // Center data points within each day segment for better label alignment
                        const segmentWidth = graphWidth / data.length;
                        const x = padding + (index * segmentWidth) + (segmentWidth / 2);
                        const value = item[category] || 0;
                        const y = padding + graphHeight - (value / maxValue * graphHeight);
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                    
                    // Draw dots on data points
                    data.forEach((item, index) => {
                        const segmentWidth = graphWidth / data.length;
                        const x = padding + (index * segmentWidth) + (segmentWidth / 2);
                        const value = item[category] || 0;
                        const y = padding + graphHeight - (value / maxValue * graphHeight);
                        
                        if (value > 0) {
                            ctx.beginPath();
                            ctx.arc(x, y, 4, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                    });
                });
                
                // Draw Y-axis labels on canvas with proper scaling
                ctx.fillStyle = '#666';
                ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                // Use smarter step calculation like the bar charts do
                const getStepSize = (max) => {
                    if (max <= 1) return 1;
                    if (max <= 5) return 1;
                    if (max <= 10) return 2;
                    if (max <= 25) return 5;
                    if (max <= 50) return 10;
                    if (max <= 100) return 20;
                    return Math.ceil(max / 5);
                };
                
                const stepSize = getStepSize(maxValue);
                const steps = Math.ceil(maxValue / stepSize);
                
                // Draw from 0 at bottom to maxValue at top
                for (let i = 0; i <= steps; i++) {
                    const value = i * stepSize;
                    const y = padding + graphHeight - (value / maxValue * graphHeight);
                    if (value <= maxValue) {
                        ctx.fillText(value.toString(), padding - 10, y);
                    }
                }
            }

            renderDayActivity() {
                const selectedDateString = this.selectedDate.toDateString();
                const selectedDateEntries = this.entries.filter(e => {
                    const entryDate = new Date(e.timestamp);
                    return entryDate.toDateString() === selectedDateString;
                }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Most recent first

                if (selectedDateEntries.length === 0) {
                    this.activityList.innerHTML = `
                        <div class="empty-state">
                            No activity recorded for ${this.selectedDate.toLocaleDateString()}.
                        </div>
                    `;
                    return;
                }

                const activityHTML = selectedDateEntries.map(entry => {
                    const entryDate = new Date(entry.timestamp);
                    const timeString = entryDate.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });

                    // Determine entry class and type label
                    const entryClass = `${entry.category}-${entry.type === 'craving' ? 'craving' : 'consumed'}`;
                    const typeClass = entryClass;
                    
                    let typeLabel = '';
                    if (entry.category === 'vaping') {
                        typeLabel = entry.type === 'craving' ? 'VAPING CRAVING' : 'VAPED';
                    } else {
                        typeLabel = entry.type === 'craving' ? 'ALCOHOL CRAVING' : 'DRANK';
                    }

                    // Format cost display for alcohol entries
                    const costDisplay = (entry.type === 'smoked' && entry.category === 'alcohol' && entry.cost !== null && entry.cost > 0) 
                        ? `<div class="activity-cost">¬£${entry.cost.toFixed(2)}</div>` 
                        : '';
                        
                    return `
                        <div class="activity-entry ${entryClass}" data-entry-id="${entry.id}">
                            <div>
                                <div class="activity-time">${timeString}</div>
                                ${costDisplay}
                                ${this.showNotes && entry.note ? `<div class="activity-note">${entry.note}</div>` : ''}
                            </div>
                            <div class="activity-actions">
                                <div class="activity-type ${typeClass}">${typeLabel}</div>
                                <button class="edit-entry-btn" data-entry-id="${entry.id}" title="Edit entry">‚úèÔ∏è</button>
                                <button class="delete-entry-btn" data-entry-id="${entry.id}" title="Delete entry">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');

                this.activityList.innerHTML = activityHTML;
                
                // Add event listeners to edit buttons
                const editBtns = this.activityList.querySelectorAll('.edit-entry-btn');
                editBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const entryId = parseInt(btn.dataset.entryId);
                        this.showEditModal(entryId);
                    });
                });

                // Add event listeners to delete buttons
                const deleteBtns = this.activityList.querySelectorAll('.delete-entry-btn');
                deleteBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const entryId = parseInt(btn.dataset.entryId);
                        this.deleteEntry(entryId);
                    });
                });
            }

            // Notes visibility preference
            loadNotesSetting() {
                try {
                    const saved = localStorage.getItem('showNotes');
                    if (saved !== null) {
                        this.showNotes = JSON.parse(saved) === true;
                    }
                } catch (e) {
                    this.showNotes = true;
                }
            }

            saveNotesSetting() {
                try {
                    localStorage.setItem('showNotes', JSON.stringify(this.showNotes));
                } catch (e) {
                    // noop
                }
            }

            updateNotesToggleUI() {
                if (this.notesToggle) {
                    this.notesToggle.classList.toggle('active', this.showNotes === true);
                }
            }

            toggleNotesVisibility() {
                this.showNotes = !this.showNotes;
                this.saveNotesSetting();
                this.updateNotesToggleUI();
                // Refresh activity list if visible
                if (this.currentPeriod === 'day') {
                    this.renderDayActivity();
                }
            }

            updatePeriodLabel() {
                const now = new Date();
                
                if (this.currentPeriod === 'week') {
                    const weekDate = new Date(now);
                    weekDate.setDate(weekDate.getDate() + (this.weekOffset * 7));
                    const currentDay = weekDate.getDay();
                    const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
                    const monday = new Date(weekDate);
                    monday.setDate(weekDate.getDate() + mondayOffset);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    
                    this.periodLabel.textContent = `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                } else if (this.currentPeriod === 'month') {
                    const monthDate = new Date(now.getFullYear(), now.getMonth() + this.monthOffset, 1);
                    this.periodLabel.textContent = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }
            }

            toggleBurgerMenu() {
                const isOpen = this.burgerDropdown.classList.contains('show');
                if (isOpen) {
                    this.closeBurgerMenu();
                } else {
                    this.openBurgerMenu();
                }
            }

            openBurgerMenu() {
                this.burgerDropdown.classList.add('show');
                this.burgerOverlay.classList.add('show');
            }

            closeBurgerMenu() {
                this.burgerDropdown.classList.remove('show');
                this.burgerOverlay.classList.remove('show');
            }

            toggleCategoryVisibility(category) {
                // Prevent rapid clicking
                if (this.updatingVisibility) {
                    return;
                }
                
                this.updatingVisibility = true;
                
                try {
                    this.categoryVisibility[category] = !this.categoryVisibility[category];
                    this.saveCategoryVisibilitySettings();
                    this.updateCategoryVisibility();
                    this.renderChart();
                } catch (error) {
                    console.error('Error toggling category visibility:', error);
                } finally {
                    // Clear the flag after a short delay
                    setTimeout(() => {
                        this.updatingVisibility = false;
                    }, 100);
                }
            }

            updateCategoryVisibility(skipInterfaceRestore = false) {
                const visibleCategories = Object.values(this.categoryVisibility).filter(visible => visible).length;
                const isEmptyState = document.querySelector('.main .empty-state') !== null && !document.querySelector('.timeline-controls');
                
                // If transitioning from empty state to having visible categories, restore the interface
                if (!skipInterfaceRestore && isEmptyState && visibleCategories > 0) {
                    this.restoreFullInterface();
                    return;
                }
                
                // If no categories are visible, show empty state
                if (visibleCategories === 0) {
                    this.showEmptyState();
                    return;
                }
                
                // Update toggle switches if they exist
                if (this.vapingToggle && this.alcoholToggle) {
                    this.vapingToggle.classList.toggle('active', this.categoryVisibility.vaping);
                    this.alcoholToggle.classList.toggle('active', this.categoryVisibility.alcohol);
                }

                // Update filter buttons based on visibility
                if (this.vapingFilter && this.alcoholFilter) {
                    this.vapingFilter.style.display = this.categoryVisibility.vaping ? 'block' : 'none';
                    this.alcoholFilter.style.display = this.categoryVisibility.alcohol ? 'block' : 'none';
                }

                // Remove hidden categories from active filters
                if (!this.categoryVisibility.vaping && this.activeFilters.has('vaping')) {
                    this.activeFilters.delete('vaping');
                }
                if (!this.categoryVisibility.alcohol && this.activeFilters.has('alcohol')) {
                    this.activeFilters.delete('alcohol');
                }

                // Update filter button states
                this.updateFilterButtons();
                this.updateLegend();
            }

            updateFilterButtons() {
                // Update filter button states based on active filters and visibility
                this.filterBtns.forEach(btn => {
                    const filter = btn.dataset.filter;
                    if (filter === 'all') {
                        btn.classList.toggle('active', this.activeFilters.has('vaping') && this.activeFilters.has('alcohol'));
                    } else {
                        btn.classList.toggle('active', this.activeFilters.has(filter));
                    }
                });
            }

            updateLegend() {
                const legend = document.getElementById('chartLegend');
                if (!legend) return;

                let legendHTML = '';
                
                if (this.categoryVisibility.vaping) {
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color cravings"></div>
                            <span>Vaping Cravings</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color vaped"></div>
                            <span>Vaped</span>
                        </div>
                    `;
                }
                
                if (this.categoryVisibility.alcohol) {
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color alcohol-cravings"></div>
                            <span>Alcohol Cravings</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color alcohol-consumed"></div>
                            <span>Drank</span>
                        </div>
                    `;
                }
                
                legend.innerHTML = legendHTML;
            }

            updateIntensityLabel(value, labelElement) {
                ModalUtils.updateIntensityLabel(value, labelElement);
            }

            showEditModal(entryId) {
                const entry = this.entries.find(e => e.id === entryId);
                if (!entry) {
                    alert('Entry not found!');
                    return;
                }

                this.currentEditingId = entry.id;
                
                // Use shared utility to populate the form
                const elements = {
                    typeSelect: this.editEntryType,
                    dateInput: this.editEntryDate,
                    timeInput: this.editEntryTime,
                    noteInput: this.editNote,
                    intensityGroup: this.editIntensityGroup,
                    intensitySlider: this.editIntensity,
                    intensityValue: this.editIntensityValue,
                    costGroup: this.editCostGroup,
                    costSlider: this.editCost,
                    costValue: this.editCostValue
                };
                
                ModalUtils.populateEditForm(entry, elements);
                this.editEntryModal.style.display = 'block';
            }

            hideEditModal() {
                this.editEntryModal.style.display = 'none';
                this.editEntryForm.reset();
                this.currentEditingId = null;
            }

            async deleteEntry(entryId) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    try {
                        this.entries = this.entries.filter(entry => entry.id !== entryId);
                        await this.dataStore.saveEntries(this.entries);
                        this.updateHeaderStats();
                        this.renderChart();
                    } catch (error) {
                        console.error('Failed to delete entry:', error);
                        alert('Failed to delete entry. Please try again.');
                    }
                }
            }

            async handleEditSubmit(e) {
                e.preventDefault();
                
                try {
                    const type = this.editEntryType.value;
                    const date = this.editEntryDate.value;
                    const time = this.editEntryTime.value;
                    const note = this.editNote.value.trim();
                    
                    // Use shared validation
                    if (!ModalUtils.validateEntry(date, time)) {
                        return;
                    }
                    
                    // Find and update the entry
                    const entryIndex = this.entries.findIndex(e => e.id === this.currentEditingId);
                    
                    if (entryIndex === -1) {
                        alert('Entry not found!');
                        return;
                    }
                    
                    const entry = this.entries[entryIndex];
                    const timestamp = new Date(`${date}T${time}`);
                    
                    this.entries[entryIndex] = {
                        ...entry,
                        type: type,
                        timestamp: timestamp.toISOString(),
                        note: note,
                        date: timestamp.toDateString(),
                        intensity: type === 'craving' ? parseInt(this.editIntensity.value) : null,
                        cost: (type === 'smoked' && entry.category === 'alcohol') ? (parseInt(this.editCost.value) * 0.25) : null
                    };
                    
                    // Re-sort entries by timestamp
                    this.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Save to data store
                    await this.dataStore.saveEntries(this.entries);
                    this.hideEditModal();
                    
                    // Update the display
                    this.updateHeaderStats();
                    this.renderChart();
                    this.renderDayActivity(); // Refresh the day activity list
                    
                } catch (error) {
                    console.error('Error in handleEditSubmit:', error);
                    alert('Failed to save changes: ' + error.message);
                }
            }

            showEmptyState() {
                const main = document.querySelector('.main');
                main.innerHTML = `
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <div class="burger-overlay" id="burgerOverlay"></div>
                    <div class="empty-state" style="padding: 60px 20px; text-align: center;">
                        <h3 style="color: #a0aec0; margin-bottom: 15px;">No Categories Enabled</h3>
                        <p style="color: #a0aec0;">Enable at least one category in the menu (‚ò∞) to start viewing timeline data.</p>
                    </div>
                `;
                // Re-bind events since elements were recreated
                this.importFile = document.getElementById('importFile');
                this.burgerOverlay = document.getElementById('burgerOverlay');
                this.importFile.addEventListener('change', (e) => this.importData(e));
                this.burgerOverlay.addEventListener('click', () => this.closeBurgerMenu());
                
                // Update toggle references and visual state
                this.vapingToggle = document.getElementById('vapingToggle');
                this.alcoholToggle = document.getElementById('alcoholToggle');
                if (this.vapingToggle && this.alcoholToggle) {
                    this.vapingToggle.classList.toggle('active', this.categoryVisibility.vaping);
                    this.alcoholToggle.classList.toggle('active', this.categoryVisibility.alcohol);
                }
            }

            restoreFullInterface() {
                const main = document.querySelector('.main');
                main.innerHTML = `
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <div class="burger-overlay" id="burgerOverlay"></div>
                    
                    <div class="timeline-controls">
                        <button class="period-btn active" data-period="day">Day</button>
                        <button class="period-btn" data-period="week">Week</button>
                        <button class="period-btn" data-period="month">Month</button>
                        <button class="period-btn" data-period="year">Year</button>
                    </div>

                    <div class="filter-controls">
                        <button class="filter-btn active" data-filter="all" id="allFilter">
                            üìä All Data
                        </button>
                        <button class="filter-btn active" data-filter="vaping" id="vapingFilter">
                            üí® Vaping
                        </button>
                        <button class="filter-btn active" data-filter="alcohol" id="alcoholFilter">
                            üç∑ Alcohol
                        </button>
                    </div>

                    <div class="timeline-chart">
                        <div class="chart-title" id="chartTitle">Daily Timeline</div>
                        
                        <!-- Date navigation controls for day view -->
                        <div class="date-navigation" id="dateNavigation" style="display: none;">
                            <button class="nav-btn-small" id="prevDateBtn">‚óÄ</button>
                            <input type="date" id="selectedDate" class="date-input">
                            <button class="nav-btn-small" id="nextDateBtn">‚ñ∂</button>
                            <button class="nav-btn-small" id="todayDateBtn">Today</button>
                        </div>

                        <!-- Period navigation controls for week/month views -->
                        <div class="period-navigation" id="periodNavigation" style="display: none;">
                            <button class="nav-btn-small" id="prevPeriodBtn">‚óÄ Previous</button>
                            <span class="period-label" id="periodLabel">Current Period</span>
                            <button class="nav-btn-small" id="nextPeriodBtn">Next ‚ñ∂</button>
                            <button class="nav-btn-small" id="currentPeriodBtn">Current</button>
                        </div>
                        <div class="chart-container">
                            <div class="y-axis" id="yAxis">
                                <!-- Y-axis labels will be generated by JavaScript -->
                            </div>
                            <div class="chart-bars-container">
                                <div class="chart-bars" id="chartBars">
                                    <div class="empty-state">
                                        No data available for the selected period.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="legend" id="chartLegend">
                            <div class="legend-item">
                                <div class="legend-color cravings"></div>
                                <span>Vaping Cravings</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color vaped"></div>
                                <span>Vaped</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color alcohol-cravings"></div>
                                <span>Alcohol Cravings</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color alcohol-consumed"></div>
                                <span>Drank</span>
                            </div>
                        </div>
                    </div>

                    <div class="summary-stats" id="summaryStats">
                        <!-- Summary cards will be populated by JavaScript -->
                    </div>

                    <!-- Day Activity List (only shown in day view) -->
                    <div class="day-activity" id="dayActivity" style="display: none;">
                        <h3>Activity for Selected Day</h3>
                        <div class="activity-list" id="activityList">
                            <!-- Activity entries will be populated by JavaScript -->
                        </div>
                    </div>
                `;
                
                // Re-initialize elements after restoring interface
                this.initializeElements();
                this.bindEvents();
                this.updateHeaderStats();
                this.renderChart();
                this.updateCategoryVisibility(true); // Skip interface restore to prevent recursion
            }

            loadCategoryVisibilitySettings() {
                try {
                    const saved = localStorage.getItem('categoryVisibility');
                    if (saved) {
                        this.categoryVisibility = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Failed to load category visibility settings:', error);
                    // Use defaults
                    this.categoryVisibility = { vaping: true, alcohol: true };
                }
            }

            saveCategoryVisibilitySettings() {
                try {
                    localStorage.setItem('categoryVisibility', JSON.stringify(this.categoryVisibility));
                } catch (error) {
                    console.error('Failed to save category visibility settings:', error);
                }
            }

            async exportData() {
                try {
                    const exportData = await this.dataStore.exportData();
                    const blob = new Blob([exportData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `quit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    this.closeBurgerMenu();
                } catch (error) {
                    console.error('Export failed:', error);
                }
            }

            async importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const importedCount = await this.dataStore.importData(text);
                    this.entries = await this.dataStore.loadEntries();
                    this.updateHeaderStats();
                    this.renderChart();
                    this.closeBurgerMenu();
                } catch (error) {
                    console.error('Import failed:', error);
                } finally {
                    event.target.value = '';
                }
            }

            async updateApp() {
                if (!confirm('This will refresh the page to load the latest version from GitHub Pages. Continue?')) {
                    return;
                }

                this.burgerUpdateBtn.disabled = true;
                this.burgerUpdateBtn.textContent = '‚è≥ Refreshing...';
                
                // Simple page refresh - GitHub Pages automatically serves the latest version
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        // Initialize the timeline view
        document.addEventListener('DOMContentLoaded', () => {
            new TimelineView();
        });
    </script>
</body>
</html>